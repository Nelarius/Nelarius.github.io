<!DOCTYPE html>
<html>
<head>
    <title>Pathtracer Devlog // My thought repository</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    <meta name="description" content="A devlog of my pathtracer-playground project, where I am writing a physically based pathtracer using WebGPU from scratch.">
    

        <meta property="og:title" content="Pathtracer Devlog" />
    <meta property="og:description" content="This is where I write about the stuff that I&#39;ve been working on." />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en" />
    <meta property="og:url" content="https://nelari.us/post/pathtracer_devlog/" />
    

    <link rel="shortcut icon" href="/favicon.ico">

    <link href="https://nelari.us/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="https://nelari.us/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/brands.css" integrity="sha384-BKw0P+CQz9xmby+uplDwp82Py8x1xtYPK3ORn/ZSoe6Dk3ETP59WCDnX+fI1XCKK" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css" integrity="sha384-4aon80D8rXCGx9ayDt85LbyUHeMWd3UiBaWliBlJ53yzm9hqN21A+o1pqoyK04h+" crossorigin="anonymous">

    <link rel="stylesheet" href="https://nelari.us/css/style.css">
    

    <meta name="generator" content="Hugo 0.119.0">
</head>


<body>
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="https://nelari.us/">My thought repository</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="/about/">About me</a>
                
                <a class="main-nav-link" href="/projects/">Projects</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">Pathtracer Devlog</h1>
        </header>
        
        <div class="article-meta">
            <a href="/post/pathtracer_devlog/" class="article-date">
                <time datetime='2023-10-30T17:19:21.000&#43;02:00' itemprop="datePublished">2023-10-30</time>
            </a>
            
            
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <p>This post is a devlog for my <a href="https://github.com/Nelarius/pathtracer-playground">pathtracer-playground</a> project. Follow along to see the progress, starting from scratch by opening a simple window.</p>
<h2 id="the-first-physically-based-pathtracer">The first physically-based pathtracer</h2>
<p><em>2023-11-13</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/c83b83e019a44d102a79b2890ffd7897bf0977d0">c83b83e</a></em></p>
<p>A simple physically-based pathtracer is implemented. ✨ The rendering equation is solved using the following <em>Monte Carlo estimator</em>:</p>
<p>$$
F_1 = 2 \pi f_r(\mathrm{x_i},\omega_i)L_i(\mathrm{x_i},\omega_i)\omega_i\cdot\mathrm{n},
$$</p>
<p>where \(2 \pi\) is the surface area of the unit hemisphere, \(f_r\) is the reflectance distribution function, \(\omega_i\) is the incoming ray direction, and \(L_i\) is the incoming radiance along \(\omega_i\). The estimator is based on the Monte Carlo estimator for \(\int_{a}^{b} f(x) dx\), where the random variable is drawn from a uniform distribution:</p>
<p>$$
F_n = \frac{b-a}{n} \sum_{i=1}^{n} f(X_i),
$$</p>
<p>where \(n=1\) is set for now and a surface area is used instead of the 1-dimensional range.</p>
<p>For simplicity, only the Lambertian BRDF is implemented at this stage, with \(f_{\textrm{lam}}=\frac{k_{\textrm{albedo}}}{\pi}\). Drawing inspiration from <a href="https://boksajak.github.io/files/CrashCourseBRDF.pdf">Crash Course in BRDF implementation</a>, a pair of functions are implemented:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> sampleLambertian(hit: <span style="color:#2b91af">Intersection</span>, rngState: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> v = rngNextInUnitHemisphere(rngState);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> onb = pixarOnb(hit.n);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> onb * v;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> evalLambertian(hit: <span style="color:#2b91af">Intersection</span>, wi: <span style="color:#2b91af">vec3f</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> textureDesc = textureDescriptors[textureDescriptorIndices[hit.triangleIdx]];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> uv = hit.uv;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> albedo = textureLookup(textureDesc, uv);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> albedo * FRAC_1_PI * max(EPSILON, dot(hit.n, wi));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The functions are used in the path-tracing loop as follows:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">const</span> UNIFORM_HEMISPHERE_MULTIPLIER = 2f * PI;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> rayColor(primaryRay: <span style="color:#2b91af">Ray</span>, rngState: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    var ray = primaryRay;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    var color = vec3(0f);
</span></span><span style="display:flex;"><span>    var throughput = vec3(1f);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">for</span> (var bounces = 0u; bounces &lt; NUM_BOUNCES; bounces += 1u) {
</span></span><span style="display:flex;"><span>        var intersection: <span style="color:#2b91af">Intersection</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">if</span> rayIntersectBvh(ray, T_MAX, &amp;intersection) {
</span></span><span style="display:flex;"><span>            <span style="color:#00f">let</span> p = intersection.p;
</span></span><span style="display:flex;"><span>            <span style="color:#00f">let</span> scatterDirection = sampleLambertian(intersection, rngState);
</span></span><span style="display:flex;"><span>            <span style="color:#00f">let</span> scatterThroughput =
</span></span><span style="display:flex;"><span>                UNIFORM_HEMISPHERE_MULTIPLIER * evalLambertian(intersection, scatterDirection);
</span></span><span style="display:flex;"><span>            ray = Ray(p, scatterDirection);
</span></span><span style="display:flex;"><span>            throughput *= scatterThroughput;
</span></span><span style="display:flex;"><span>        } <span style="color:#00f">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#008000">// compute sky color
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>            ...
</span></span><span style="display:flex;"><span>            <span style="color:#00f">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> color;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can now pathtrace our duck. If the noise on the duck exhibits a grid-like pattern, you should open the full-size image as the website scales the images down.</p>
<p><img src="/img/pathtracer_devlog/pathtraced-duck.png" alt="pathtraced duck"></p>
<p>Now that real work is being done in the shader, the performance of Sponza on my M2 Macbook Air is starting to become punishing. Framerates are in the 1-10 FPS range with the depicted image sizes.</p>
<p><img src="/img/pathtracer_devlog/pathtraced-sponza.png" alt="pathtraced sponza"></p>
<h2 id="simple-texture-support-">Simple texture support 🖼️</h2>
<p><em>2023-11-10</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/8062be7f4a44580d6d83937b34ed57d52f4c5b35">8062be7</a></em></p>
<p>Initial textures support is added. The &ldquo;base color texture&rdquo; from the glTF &ldquo;pbr metallic roughness&rdquo; material is loaded and passed over to the GPU. The same storage buffer approach from my <a href="https://nelari.us/post/weekend_raytracing_with_wgpu_2/#adding-texture-support">Weekend raytracing with wgpu, part 2</a> post is used for texture lookup on the GPU.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#008000">// Each triangle is associated with an index to a texture descriptor, a
</span></span></span><span style="display:flex;"><span><span style="color:#008000">// placeholder for a texture on the GPU.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>@group(2) @binding(4) var&lt;storage, read_write&gt; textureDescriptorIndices: <span style="color:#2b91af">array</span>&lt;<span style="color:#2b91af">u32</span>&gt;;
</span></span><span style="display:flex;"><span><span style="color:#008000">// A texture descriptor contains an offset into the texture buffer, as
</span></span></span><span style="display:flex;"><span><span style="color:#008000">// well as the texture dimensions.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>@group(2) @binding(5) var&lt;storage, read_write&gt; textureDescriptors: <span style="color:#2b91af">array</span>&lt;TextureDescriptor&gt;;
</span></span><span style="display:flex;"><span><span style="color:#008000">// The texture buffer contains textures from all meshes, appended end to end.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>@group(2) @binding(6) var&lt;storage, read_write&gt; textures: <span style="color:#2b91af">array</span>&lt;<span style="color:#2b91af">u32</span>&gt;;
</span></span></code></pre></td></tr></table>
</div>
</div><p>On ray-triangle intersection, the model vertex UV coordinates are interpolated and the color is computed from the corresponding texel.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">if</span> rayIntersectBvh(ray, T_MAX, &amp;intersection, &amp;triangleIdx) {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> textureDesc = textureDescriptors[textureDescriptorIndices[triangleIdx]];
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> b = intersection.b;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> uvs = texCoords[triangleIdx];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> uv = b[0] * uvs[0] + b[1] * uvs[1] + b[2] * uvs[2];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    color = textureLookup(textureDesc, uv);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> textureLookup(desc: <span style="color:#2b91af">TextureDescriptor</span>, uv: <span style="color:#2b91af">vec2f</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> u = clamp(uv.x, 0f, 1f);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> v = clamp(uv.y, 0f, 1f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> j = <span style="color:#2b91af">u32</span>(u * <span style="color:#2b91af">f32</span>(desc.width));
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> i = <span style="color:#2b91af">u32</span>(v * <span style="color:#2b91af">f32</span>(desc.height));
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> idx = i * desc.width + j;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> rgba = textures[desc.offset + idx];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> vec3f(<span style="color:#2b91af">f32</span>(rgba &amp; 0xffu), <span style="color:#2b91af">f32</span>((rgba &gt;&gt; 8u) &amp; 0xffu), <span style="color:#2b91af">f32</span>((rgba &gt;&gt; 16u) &amp; 0xffu)) / 255f;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The duck model from earlier looks more like a rubber duck now.</p>
<p><img src="/img/pathtracer_devlog/textured-duck.png" alt="textured duck"></p>
<p>Sponza looks a bit rough at this stage. Two things need work.</p>
<ul>
<li>The plants in the foreground need transparency support. On intersection, the transparency of the pixel also needs to be accounted for the ray to intersect the triangle.</li>
<li>There is an issue with the textures on the ground and in some places on the walls being stretched out.</li>
</ul>
<p><img src="/img/pathtracer_devlog/sponza-attempt.png" alt="first sponza"></p>
<p>The stretched textures are likely due to a problem with UV coordinate interpolation. Single colors and suspicious red-black color gradients can be seen when coloring the model according to the triangles&rsquo; interpolated UV coordinates.</p>
<p><img src="/img/pathtracer_devlog/uv-coordinate-issue.png" alt="uv coordinate issue"></p>
<h2 id="interpolated-normals-texture-coordinates-and-gpu-timers">Interpolated normals, texture coordinates, and GPU timers</h2>
<p><em>2023-11-09</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/82208c19754a5fb6528e587c175af30f523c5649">82208c1</a></em></p>
<p><strong>GPU timers</strong></p>
<p>Timing the render pass on the device timeline allows us to keep track of how long rendering the scene actually takes on the GPU, no matter what I do on the CPU side. The timings are displayed in the UI as a moving average.</p>
<p><img src="/img/pathtracer_devlog/query-timestamps.png" alt="query-timestamps"></p>
<p>My 3080 RTX currently runs the <em>Sponza atrium</em> scene (see below) at roughly 120 FPS at fullscreen resolutions.</p>
<p><strong>Enabling allow-unsafe-apis</strong></p>
<p>WebGPU timestamp queries are disabled by default due to timings being potentially usable for client fingerprinting. Using the timestamp queries requires toggling &ldquo;allow-unsafe-apis&rdquo; (normally toggled via Chrome&rsquo;s settings) using the WebGPU native&rsquo;s struct extension mechanism:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00f">const</span> <span style="color:#2b91af">char</span>*               allowUnsafeApisToggle = <span style="color:#a31515">&#34;allow_unsafe_apis&#34;</span>;
</span></span><span style="display:flex;"><span>WGPUDawnTogglesDescriptor instanceToggles = {
</span></span><span style="display:flex;"><span>    .chain =
</span></span><span style="display:flex;"><span>        WGPUChainedStruct{
</span></span><span style="display:flex;"><span>            .next = <span style="color:#00f">nullptr</span>,
</span></span><span style="display:flex;"><span>            .sType = WGPUSType_DawnTogglesDescriptor,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    .enabledTogglesCount = 1,
</span></span><span style="display:flex;"><span>    .enabledToggles = &amp;allowUnsafeApisToggle,
</span></span><span style="display:flex;"><span>    .disabledTogglesCount = 0,
</span></span><span style="display:flex;"><span>    .disabledToggles = <span style="color:#00f">nullptr</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#00f">const</span> WGPUInstanceDescriptor instanceDesc{
</span></span><span style="display:flex;"><span>    .nextInChain = &amp;instanceToggles.chain,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#00f">const</span> WGPUInstance instance = wgpuCreateInstance(&amp;instanceDesc);
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Loading normals and texture coordinates, triangle interpolation</strong></p>
<p>The model surface normals and texture coordinates are loaded from the model. The model now exposes arrays of vertex attributes:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00f">class</span> <span style="color:#2b91af">GltfModel</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span>:
</span></span><span style="display:flex;"><span>    GltfModel(std::filesystem::path gltfPath);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Positions&gt;   positions() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mPositions; }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Normals&gt;     normals() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mNormals; }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> TexCoords&gt;   texCoords() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mTexCoords; }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> std::size_t&gt; baseColorTextureIndices() <span style="color:#00f">const</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> mBaseColorTextureIndices;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Texture&gt; baseColorTextures() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mBaseColorTextures; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">private</span>:
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>Normals and texture coordinates are interpolated at the intersection point using the intersection&rsquo;s barycentric coordinates:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">if</span> rayIntersectBvh(ray, T_MAX, &amp;intersection, &amp;triangleIdx) {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> b = intersection.b;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> tnorms = normals[triangleIdx];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> n = b[0] * tnorms[0] + b[1] * tnorms[1] + b[2] * tnorms[2];
</span></span><span style="display:flex;"><span>    color = 0.5f * (vec3f(1f, 1f, 1f) + n);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here&rsquo;s the famous <em>Sponza atrium</em> scene demonstrating the smoothly interpolated normals:</p>
<p><img src="/img/pathtracer_devlog/sponza-normal-interpolation.png" alt="sponza-interpolated-normals"></p>
<h2 id="loading-textures">Loading textures</h2>
<p><em>2023-11-08</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/170626529372f4c12c6f0d1231a4eacf83588a39">1706265</a></em></p>
<p>The glTF model loader now loads textures, and the base color textures are exposed in the model:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00f">class</span> <span style="color:#2b91af">GltfModel</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span>:
</span></span><span style="display:flex;"><span>    GltfModel(std::filesystem::path gltfPath);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Triangle&gt;    triangles() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mTriangles; }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> std::size_t&gt; baseColorTextureIndices() <span style="color:#00f">const</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> mBaseColorTextureIndices;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Texture&gt; baseColorTextures() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mBaseColorTextures; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">private</span>:
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>Each triangle has a base color texture index, and it can be used to index into the array of base color textures. Textures are just arrays of floating point values.</p>
<p>A new <code>textractor</code> executable (short for texture extractor 😄) is added. It loads a GLTF model, and then dumps each loaded texture into a <code>.ppm</code> file. This way, it can be visually inspected that the textures have been loaded correctly. For instance, here is the duck model&rsquo;s <code>base_color_texture_0</code>:</p>
<p><img src="/img/pathtracer_devlog/base_color_texture_0.jpg" alt="base_color_texture_0"></p>
<h2 id="camera-and-ui-interaction">Camera and UI interaction</h2>
<p><em>2023-11-07</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/1593e8a49309cb1a6aa375410253df53d8e7dd5e">1593e8a</a></em></p>
<p>In order to work with arbitrary 3d models, camera positions and parameters should not be hard-coded. To kickstart scene interaction, two things are implemented:</p>
<ul>
<li>A &ldquo;fly camera&rdquo;, which allows you to move around and pan the scene around using the mouse.</li>
<li>A UI integration, and a panel which allows you to edit the camera&rsquo;s speed, and vfov.</li>
</ul>
<p>The UI panel also prints out scene debug information:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Scene
</span></span><span style="display:flex;"><span>camera position: (8.00, 2.80, -8.30)
</span></span><span style="display:flex;"><span>root centroid: (0.13, 0.87, -0.04)
</span></span></code></pre></td></tr></table>
</div>
</div><p>A bug with the model loader&rsquo;s model transform meant that the duck was hundreds of units away from the camera vertically. Without the debug UI, it was hard to tell whether I just couldn&rsquo;t find the model in space, or whether the camera controller had a problem.</p>
<p><img src="/img/pathtracer_devlog/imgui-camera-interaction.png" alt="camera-imgui-interaction"></p>
<h2 id="raytracing-triangles-on-the-gpu-">Raytracing triangles on the GPU 🎉</h2>
<p><em>2023-11-06</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/e950ea8d99b467346a88bc32ca2f69f16e17f3c3">e950ea8</a></em></p>
<p>Today&rsquo;s achievement:</p>
<p><img src="/img/pathtracer_devlog/raytraced-duck-normals.png" alt="raytraced-duck"></p>
<p>The BVH and all intersection testing functions are ported to the shader. The rays from the previous devlog entry are now directly used against the BVH.</p>
<p>Porting the BVH to the GPU involved adjusting the memory layout of a number of structs. <code>Triangle</code>s, <code>Aabb</code>s, and the <code>BvhNode</code>s all have vectors in them which need to be 16-byte aligned in memory. This was achieved by padding the structs out. E.g. <code>BvhNode</code>,</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>-struct BvhNode
</span></span><span style="display:flex;"><span>-{
</span></span><span style="display:flex;"><span>-    Aabb aabb;                   // offset: 0, size: 24
</span></span><span style="display:flex;"><span>-    union
</span></span><span style="display:flex;"><span>-    {
</span></span><span style="display:flex;"><span>-        std::uint32_t trianglesOffset;
</span></span><span style="display:flex;"><span>-         std::uint32_t secondChildOffset;
</span></span><span style="display:flex;"><span>-    };                           // offset: 24, size: 4
</span></span><span style="display:flex;"><span>-    std::uint16_t triangleCount; // offset: 28, size: 2
</span></span><span style="display:flex;"><span>-    std::uint16_t splitAxis;     // offset: 30, size: 2
</span></span><span style="display:flex;"><span>-};
</span></span><span style="display:flex;"><span>+struct BvhNode
</span></span><span style="display:flex;"><span>+{
</span></span><span style="display:flex;"><span>+    Aabb32        aabb;              // offset: 0, size: 32
</span></span><span style="display:flex;"><span>+    std::uint32_t trianglesOffset;   // offset: 32, size: 4
</span></span><span style="display:flex;"><span>+    std::uint32_t secondChildOffset; // offset: 36, size: 4,
</span></span><span style="display:flex;"><span>+    std::uint32_t triangleCount;     // offset: 40, size: 4
</span></span><span style="display:flex;"><span>+    std::uint32_t splitAxis;         // offset: 44, size: 4
</span></span><span style="display:flex;"><span>+};
</span></span></code></pre></td></tr></table>
</div>
</div><p>I also tried using AI (GitHub Copilot) to translate some of the hundreds of lines of intersection testing code to WGSL. It worked well in the sense that only certain patterns of expression had to be fixed. I likely avoided errors that I would have introduced manually porting the code over.</p>
<p>🤓 TIL about the <code>@must_use</code> tag in WGSL. It&rsquo;s used as an annotation for functions which return values and don&rsquo;t have side effects. Not using the function in assignment or an expression becomes a compile error.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>@must_use
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> rayPointAtParameter(ray: <span style="color:#2b91af">Ray</span>, t: <span style="color:#2b91af">f32</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> ray.origin + t * ray.direction;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="raytracing-spheres-on-the-gpu">Raytracing spheres on the GPU</h2>
<p><em>2023-11-04</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/16f6255df4ebb34589d2541ddb9a67dbdfcf846a">16f6255</a></em></p>
<p>Before attempting to raytrace triangles on the GPU, first I need to demonstrate that the camera actually works in the shader.</p>
<p>To do so, a simple raytracing scenario is first implemented. An array of spheres, stored directly in the shader is added. Ray-sphere intersection code is copied over from my <a href="https://github.com/Nelarius/weekend-raytracer-wgpu">weekend-raytracer-wgpu</a> project. The spheres are colored according to their surface normal vector. The spheres are visible and now I know that the camera works!</p>
<p><img src="/img/pathtracer_devlog/raytraced-spheres.png" alt="raytraced-spheres"></p>
<p>The camera and the frame data struct are bundled together into on uniform buffer.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">struct</span> <span style="color:#2b91af">RenderParams</span> {
</span></span><span style="display:flex;"><span>  frameData: <span style="color:#2b91af">FrameData</span>,
</span></span><span style="display:flex;"><span>  camera: <span style="color:#2b91af">Camera</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">struct</span> <span style="color:#2b91af">FrameData</span> {
</span></span><span style="display:flex;"><span>    dimensions: <span style="color:#2b91af">vec2u</span>,
</span></span><span style="display:flex;"><span>    frameCount: <span style="color:#2b91af">u32</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">struct</span> <span style="color:#2b91af">Camera</span> {
</span></span><span style="display:flex;"><span>    eye: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>    lowerLeftCorner: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>    horizontal: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>    vertical: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>    lensRadius: <span style="color:#2b91af">f32</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>I used <a href="https://webgpufundamentals.org/webgpu/lessons/resources/wgsl-offset-computer.html#x=5d00000100bf06000000000000003d88886237289d13c4320e1a9ba574a7281bf711b8e0fe2ad3ce912bab0e0e45d434d61bb7773cbc401503b1a5422bc9bea039d06b8d7965bfdc6e368ea7d5dafe3438cbb62b089a4d9cec6dc7979747e1b214b3e964bcbcbf7488c72aa713fe7c5d73817e3b3f445d649816a64ac8072c28ba8c3dce046ddbe50ca41aeaa4c22ead3b60c0acb96d367309eaec44952e3088be8405bf4fae4fc8cca8764a61cee989b43b51c4fcd21564ea233ad813d4a383f2d702e9cc9f4da3f8a794715769609bd818144076ed26f05db15962b5ef3ed314fd1b0f9538ccaad3e137698dc9d42ff06c08084bc32a2d7e8edc871d8dee675148c5a69cbb85d7d8d2c61bfa357e3f573512742e291a19227c79587c6bc9e71e9b15305f2fe76e51479fea54e4d78276c06f0294f47a21d12a3b09f6e1d1ef457fdd7aed7c590bfa02acd462ad6ff2d7e62dbb7609d8b4139cb0812f4a4a96b489b24a1963fe930c202c18a8229db2e5accddd0b19c255588f10410f76e862e928cedfaa31322b931e77c0ba9b0b20c07bb7d05903330cd8008ce0ce0318e88decdbb3906947888459f57609602735cfa2db9c606f77bcc82c6500001280a20b784b165a2e3e1d3273bbbf21bd2e6b828ac3e04932d4f50adc1059d34176dbce9a8f0725b8fa47e3968be59bbd8b85e3a3db336c824942704a1cc7aa5a982120d7d7e9113d2706ab1b6051452e4f4c087985d5bd5c5c749bc6cc8e0faafba53e2a04a3db328d4d21224c6447f924a9aae62dff94d9287ecc977a49eb75d4e4ac92e4c77b755f13210bb0a3899a30f4cf264b2f8cebfdbaf9a827c79b4babb8c669dd0045488f010ab17f6c12b6d529b0b35ef34a0d8fb7c5831891fe979eea">WGSL Offset Computer</a>, a great online resource for enumerating and drawing the memory layout of your WGSL structs, as a sanity check that my memory layout for <code>renderParams</code> was correct.</p>
<p><img src="/img/pathtracer_devlog/renderparams-layout.jpg" alt="renderparams-memory-layout"></p>
<h2 id="hello-bounding-volume-hierarchies">Hello, bounding volume hierarchies</h2>
<p><em>2023-11-02</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/624e5ead16424fb75c2fd37cac0c9edd0f113690">624e5ea</a></em></p>
<p>This entry marks the first step towards being able to shoot rays at complex triangle geometry. A bounding volume hierarchy (BVH) is introduced (<code>common/bvh.hpp</code>) and tested.</p>
<p>The test (<code>tests/bvh.cpp</code>) intersects rays with the BVH, and uses a brute-force test against the full array of triangles as the ground truth. The intersection test result (did intersect or did not) and the intersection point, in the case of intersection, must agree for all camera rays in order for the test to pass.</p>
<p>As an additional end-to-end sanity check, a new executable target (<code>bvh-visualizer</code>) is introduced. Primary camera rays are generated and the number of BVH nodes visited per ray is visualized as an image.</p>
<p><img src="/img/pathtracer_devlog/duck-bvh.jpg" alt="duck bvh"></p>
<h2 id="gpubuffer"><code>GpuBuffer</code></h2>
<p><em>2023-11-01</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/0a826c4d6e3649c2de906b60d153469f97e20e7e">0a826c4</a></em></p>
<p>Not a lot of visible progress, but <code>GpuBuffer</code> was introduced (in <code>gpu_buffer.hpp</code>) to significantly reduce the amount of boilerplate due to buffers &amp; bind group descriptors:</p>
<p>Showing 5 changed files with <strong>254 additions</strong> and <strong>275 deletions</strong>.</p>
<p>On another note, used <em>immediately invoked lambda functions</em> in a constructor initializer for the first time today:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Renderer::Renderer(<span style="color:#00f">const</span> RendererDescriptor&amp; rendererDesc, <span style="color:#00f">const</span> GpuContext&amp; gpuContext)
</span></span><span style="display:flex;"><span>    : frameDataBuffer(...),
</span></span><span style="display:flex;"><span>      pixelBuffer(
</span></span><span style="display:flex;"><span>          gpuContext.device,
</span></span><span style="display:flex;"><span>          <span style="color:#a31515">&#34;pixel buffer&#34;</span>,
</span></span><span style="display:flex;"><span>          WGPUBufferUsage_CopyDst | WGPUBufferUsage_Storage,
</span></span><span style="display:flex;"><span>          [&amp;rendererDesc]() -&gt; std::size_t {
</span></span><span style="display:flex;"><span>              <span style="color:#00f">const</span> Extent2i    largestResolution = rendererDesc.maxFramebufferSize;
</span></span><span style="display:flex;"><span>              <span style="color:#00f">const</span> std::size_t numPixels =
</span></span><span style="display:flex;"><span>                  <span style="color:#00f">static_cast</span>&lt;std::size_t&gt;(largestResolution.x * largestResolution.y);
</span></span><span style="display:flex;"><span>              <span style="color:#00f">return</span> sizeof(glm::vec3) * numPixels;
</span></span><span style="display:flex;"><span>          }()),
</span></span><span style="display:flex;"><span>      ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s busy looking, but it enables you to do actual work in the constructor initializer. Doing all the work in the constructor initializers like this could make move constructors unnecessary.</p>
<h2 id="gpu-generated-noise">GPU-generated noise</h2>
<p><em>2023-10-31</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/645c09c377face80354e820875c0be9181a18124">645c09c</a></em></p>
<p>The major highlights of the day include generating noise on the GPU and displaying it, as well as cleaning up the main function using a new <code>Window</code> abstraction.</p>
<p><strong><code>Window</code></strong></p>
<p>A simple <code>Window</code> abstraction is introduced to automate GLFW library and window init and cleanup. <code>main</code> does not yet have an exception handler, but this abstraction is a step closer to ensuring all resources are cleaned up even when exceptions occur.</p>
<p><strong>GPU noise</strong></p>
<p>Noise is generated on the GPU using the following functions.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> rngNextFloat(state: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) -&gt; <span style="color:#2b91af">f32</span> {
</span></span><span style="display:flex;"><span>    rngNextInt(state);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> <span style="color:#2b91af">f32</span>(*state) / <span style="color:#2b91af">f32</span>(0xffffffffu);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> rngNextInt(state: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) {
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// PCG random number generator
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">// Based on https://www.shadertoy.com/view/XlGcRh
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> oldState = *state + 747796405u + 2891336453u;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> word = ((oldState &gt;&gt; ((oldState &gt;&gt; 28u) + 4u)) ^ oldState) * 277803737u;
</span></span><span style="display:flex;"><span>    *state = (word &gt;&gt; 22u) ^ word;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Each frame,</p>
<ol>
<li><code>rngNextFloat</code> is used in a compute shader to generate RGB values</li>
<li>RGB values are stored in a pixel buffer</li>
<li>The pixel buffer is mapped to the full screen quad from the previous day.</li>
</ol>
<p>This approach is a bit more complex than necessary, and could just be done in the fragment shader.</p>
<p><img src="/img/pathtracer_devlog/gpu-noise.png" alt="gpu noise"></p>
<h2 id="fullscreen-quad">Fullscreen quad</h2>
<p><em>2023-10-30</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/51387d7b447800b0ffc25e3f2c1526e6fc2bf0f5">51387d7</a></em></p>
<p>After 1000 lines of WebGPU plumbing code, the first <em>pair</em> of triangles is displayed on the screen in the shape of a fullscreen quad, and the UV coordinates are displayed as a color.</p>
<p>The <code>pt</code> executable contains</p>
<ul>
<li>A <code>GpuContext</code> for initializing the WebGPU instance, surface, adapter, device, queue, and the swap chain.</li>
<li>A distinct <code>Renderer</code> which initializes a render pipeline, a uniform and vertex buffer, using the <code>GpuContext</code>.</li>
</ul>
<p>The renderer draws to the screen using a fullscreen quad. For now, the texture coordinates are displayed as colors.</p>
<p><img src="/img/pathtracer_devlog/fullscreen-quad.png" alt="fullscreen quad"></p>
<h2 id="hello-glfw">Hello, GLFW!</h2>
<p><em>2023-10-29</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/pathtracer-playground/commit/4df39fa7a165f10e7582847c999bf02e60a6ec6a">4df39fa</a></em></p>
<p>All projects have to start somewhere.</p>
<ul>
<li>Defined a <code>pt</code> executable target in CMake. The goal is for this executable to open up a scene and display it by doing pathtracing on the GPU.</li>
<li>The GLFW library dependency added using CMake&rsquo;s <code>FetchContent</code>.</li>
<li>An empty window is opened with a window title. No GPU rendering support yet, only calls to <code>glfwSwapBuffers</code>.</li>
</ul>
<p>A windows opens with a black frame.</p>
<p><img src="/img/pathtracer_devlog/hello-glfw.png" alt="hello, glfw"></p>

        </div>

        
        
        <div class="article-toc" >
            <h3>Contents</h3>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#the-first-physically-based-pathtracer">The first physically-based pathtracer</a></li>
    <li><a href="#simple-texture-support-">Simple texture support 🖼️</a></li>
    <li><a href="#interpolated-normals-texture-coordinates-and-gpu-timers">Interpolated normals, texture coordinates, and GPU timers</a></li>
    <li><a href="#loading-textures">Loading textures</a></li>
    <li><a href="#camera-and-ui-interaction">Camera and UI interaction</a></li>
    <li><a href="#raytracing-triangles-on-the-gpu-">Raytracing triangles on the GPU 🎉</a></li>
    <li><a href="#raytracing-spheres-on-the-gpu">Raytracing spheres on the GPU</a></li>
    <li><a href="#hello-bounding-volume-hierarchies">Hello, bounding volume hierarchies</a></li>
    <li><a href="#gpubuffer"><code>GpuBuffer</code></a></li>
    <li><a href="#gpu-generated-noise">GPU-generated noise</a></li>
    <li><a href="#fullscreen-quad">Fullscreen quad</a></li>
    <li><a href="#hello-glfw">Hello, GLFW!</a></li>
  </ul>
</nav>
        </div>
        
        

        


        
        <footer class="article-footer">
            <ul class="article-tag-list">
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://nelari.us/tags/raytracing">raytracing
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://nelari.us/tags/cpp">cpp
                    </a>
                </li>
                
            </ul>
        </footer>
        
    </div>
    
<nav id="article-nav">
    
    
    <a href="/post/weekend_raytracing_with_wgpu_2/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">Weekend raytracing with wgpu, part 2&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>


</article>

        
    </section>
    <footer id="footer">
    <div class="outer">
            <section class="footer-social">
      
      <a href="//twitter.com/nelarius" target="_blank" title="Twitter"><i class="fab fa-2x fa-fw fa-twitter"></i></a>&nbsp;
      
      
      <a href="//www.linkedin.com/in/nelarius" target="_blank" title="linkedIn"><i class="fab fa-2x fa-fw fa-linkedin"></i></a>&nbsp;
      
      
      
      
      
      <a href="//github.com/Nelarius" target="_blank" title="GitHub"><i class="fab fa-2x fa-fw fa-github"></i></a>&nbsp;
      
      
      
</section>

            <br/>
        <div id="footer-info" class="inner">
            &copy; 2023 Johann Muszynski
        </div>
    </div>
    

    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha256-ExtbCSBuYA7kq1Pz362ibde9nnsHYPt6JxuxYeZbU+c=" crossorigin="anonymous"></script>
        <script>renderMathInElement(document.body);</script>
    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>
