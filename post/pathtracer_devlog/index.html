<!DOCTYPE html>
<html>
<head>
    <title>GPU Pathtracer Devlog // My thought repository</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    <meta name="description" content="A devlog of my GPU pathtracer project, where I am writing a physically based pathtracer from scratch using WebGPU.">
    

        <meta property="og:title" content="GPU Pathtracer Devlog" />
    <meta property="og:description" content="This is where I write about the stuff that I&#39;ve been working on." />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en" />
    <meta property="og:url" content="https://nelari.us/post/pathtracer_devlog/" />
    

    <link rel="shortcut icon" href="/favicon.ico">

    <link href="https://nelari.us/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="https://nelari.us/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/brands.css" integrity="sha384-BKw0P+CQz9xmby+uplDwp82Py8x1xtYPK3ORn/ZSoe6Dk3ETP59WCDnX+fI1XCKK" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css" integrity="sha384-4aon80D8rXCGx9ayDt85LbyUHeMWd3UiBaWliBlJ53yzm9hqN21A+o1pqoyK04h+" crossorigin="anonymous">

    <link rel="stylesheet" href="https://nelari.us/css/style.css">
    

    <meta name="generator" content="Hugo 0.119.0">
</head>


<body>
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="https://nelari.us/">My thought repository</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="/about/">About me</a>
                
                <a class="main-nav-link" href="/projects/">Projects</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">GPU Pathtracer Devlog</h1>
        </header>
        
        <div class="article-meta">
            <a href="/post/pathtracer_devlog/" class="article-date">
                <time datetime='2023-10-30T17:19:21.000&#43;02:00' itemprop="datePublished">2023-10-30</time>
            </a>
            
            
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <p>This post is a devlog for my <a href="https://github.com/Nelarius/rayfinder">rayfinder</a> project. Follow along to see the progress, starting from scratch by opening a simple window.</p>
<h2 id="first-step-towards-temporal-filtering-simple-accumulation">First step towards temporal filtering: simple accumulation</h2>
<p><em>2024-06-24</em></p>
<p><em>Commit</em>: <a href="https://github.com/Nelarius/rayfinder/commit/29eebc8aad7df205ec35dda4bd1e4eca4b0e4ac9">29eebc8</a></p>
<p>The first step towards temporal accumulation with a moving camera is implemented. The reference path tracer previously implemented temporal accumulation, but only when the camera was stationary. When the camera was moved, the render was invalidated and started from scratch.</p>
<p>The temporal accumulation is inspired by the <a href="https://www.elopezr.com/temporal-aa-and-the-quest-for-the-holy-trail/">Temporal AA and the Quest for the holy Trail</a> blog post. The first two steps, jitter and resolve, are implemented here.</p>
<p>The jitter matrix offsets the image by a random subpixel amount each from, along the x and y axis. I used the <a href="https://extremelearning.com.au/unreasonable-effectiveness-of-quasirandom-sequences/">2-dimensional golden ratio sequence</a> as a source of low-discrepancy values, just like previously in the animated blue noise section.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>glm::mat4       jitterMat = glm::mat4(1.0f);
</span></span><span style="display:flex;"><span><span style="color:#00f">const</span> glm::vec2 j = r2Sequence(frameCount, 1 &lt;&lt; 20);
</span></span><span style="display:flex;"><span>jitterMat[3][0] = (j.x - 0.5f) / framebufferSize.x;
</span></span><span style="display:flex;"><span>jitterMat[3][1] = (j.y - 0.5f) / framebufferSize.y;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The view projection matrix is replaced with the view projection matrix multiplied by this jitter matrix. The image jitters slightly, yielding samples from different parts of the pixel over time.</p>
<p>Next, in the resolve pass, the pixel&rsquo;s final color is computed based on the current and previous frame&rsquo;s sample. The current color sample is computed in the lighting pass. The image no longer jitters after this accumulation step as the samples from the different parts of the pixel are averaged together to produce a stable pixel value.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#008000">// The storage buffer populated by the raytracing compute shader.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>@group(1) @binding(0) var&lt;storage, read_write&gt; sampleBuffer: <span style="color:#2b91af">array</span>&lt;array&lt;<span style="color:#2b91af">f32</span>, 3&gt;&gt;;
</span></span><span style="display:flex;"><span><span style="color:#008000">// The storage buffer for persisting the previous samples.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>@group(1) @binding(1) var&lt;storage, read_write&gt; accumulationBuffer: <span style="color:#2b91af">array</span>&lt;array&lt;<span style="color:#2b91af">f32</span>, 3&gt;&gt;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000">// elsewhere in code...
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> sample = sampleBuffer[sampleBufferIdx];
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> currentColor = vec3f(sample[0], sample[1], sample[2]);
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> previousSample = accumulationBuffer[sampleBufferIdx];
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> previousColor = vec3f(previousSample[0], previousSample[1], previousSample[2]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>color = 0.1 * currentColor + 0.9 * previousColor;
</span></span><span style="display:flex;"><span>accumulationBuffer[sampleBufferIdx] = array&lt;<span style="color:#2b91af">f32</span>, 3&gt;(color.r, color.g, color.b);
</span></span></code></pre></td></tr></table>
</div>
</div><p>This simple sample accumulation produces an image with much less noise than before. However, the moving average alone does not account for the moving camera and results in ghosting artifacts due to camera motion.</p>
<video controls preload="auto" width="100%"  autoplay playsinline class="html-video">
    <source src="/post/pathtracer_devlog/duck-camera-ghosting.mp4" type="video/mp4">
  <span></span>
</video>
<h2 id="raytracing-in-a-compute-pipeline">Raytracing in a compute pipeline</h2>
<p><em>2024-06-21</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/d06c8c93c160da3f48369666d95e369a167c3932">d06c8c9</a></em></p>
<p>Raytracing is moved from the fragment shader to a compute shader. The compute shader outputs the color into a storage buffer. A new render pass, the <em>resolve pass</em>, is introduced. It renders a fullscreen quad, and outputs the color from the storage buffer as the fragment color. The modification is fairly straightforward, except for one gotcha.</p>
<p>Previously, the depth buffer was sampled using a <code>textureIdx</code> calculated from the UV coordinate from the vertex shader.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">let</span> uv = <span style="color:#00f">in</span>.texCoord;
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> textureIdx = vec2u(floor(uv * uniforms.framebufferSize));
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> depthSample = textureLoad(gbufferDepth, textureIdx, 0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">if</span> depthSample == 0.0 {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> world = worldFromUv(uv, depthSample);
</span></span><span style="display:flex;"><span><span style="color:#008000">// ...
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The UV coordinate from the vertex shader is located at the center of the pixel, and is exactly where the depth sample is located.</p>
<p>In the compute shader, texture index and the UV coordinate is calculated the other way around. In the compute shader, we dispatch one job per pixel, and we can treat the global shader invocation id as a texture index. We compute the UV based on the texture index. This is the naive way of doing it:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">let</span> textureIdx = globalInvocationId.xy;
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> uv = vec2f(globalInvocationId.xy) / uniforms.framebufferSize;
</span></span></code></pre></td></tr></table>
</div>
</div><p>This will result in completely broken rendering (ask me how I know!).</p>
<p><img src="/img/pathtracer_devlog/broken-inverse-projection.png" alt="broken-inverse-projection"></p>
<p>The depth sample at <code>textureIdx</code> and the UV coordinate don&rsquo;t align. The world space position we calculate from these two values is incorrect, resulting in ray self-intersection issues. The correct way to proceed is to place the UV coordinate <strong>at the center of the pixel</strong>, so that it matches the place where the depth sample was taken:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">let</span> textureIdx = globalInvocationId.xy;
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> uv = (vec2f(globalInvocationId.xy) + vec2f(0.5)) / uniforms.framebufferSize;
</span></span></code></pre></td></tr></table>
</div>
</div><p>With this in place, raytracing in the compute shader produces identical result to before.</p>
<h2 id="animated-blue-noise">Animated blue noise</h2>
<p><em>2024-05-11</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/18f5dbb515a48ae4df7fc64cc457052de2e457e4">18f5dbb</a></em></p>
<p>An improved sampling noise distribution is implemented.</p>
<p>The type of noise used to produce the random numbers used to sample the light and surface normal has an impact on the final image. The pathtracer has been using &ldquo;white noise&rdquo; so far, so-called because it contains both high and low-frequency jitters. The randomly generated points can contain clusters and voids, and doesn&rsquo;t necessarily cover the space very evenly.</p>
<p>Quasirandom numbers, such as the additive recurrence R-sequence (explained in depth in <a href="https://extremelearning.com.au/unreasonable-effectiveness-of-quasirandom-sequences/">Unreasonable Effectiveness of Quasirandom Sequences</a>), fill up the space much more evenly than regular random numbers (i.e. it has low spatial discrepancy):</p>
<p><img src="/img/pathtracer_devlog/cartesian-noise.png" alt="cartesian-noise"></p>
<p>R-sequences are very easy to generate. They are driven by a an increasing sequence of integers:</p>
<pre tabindex="0"><code># See the &#34;Unreasonable Effectiveness of Quasirandom Sequences&#34; post for more definitions
def r2(n):
   g = 1.32471795724474602596
   a1 = 1.0/g
   a2 = 1.0/(g*g)
   return ((0.5+a1*n) % 1), ((0.5+a2*n) % 1)
</code></pre><p>The R-sequence can be used in place of white noise also when sampling random numbers in distributions or geometric primitives:</p>
<p><img src="/img/pathtracer_devlog/circle-distribution.png" alt="circle-distribution"></p>
<p><img src="/img/pathtracer_devlog/cosine-hemisphere-distribution.png" alt="cone-distribution"></p>
<p>For each frame, you get a different value with very low spatial discrepancy. Unfortunately, the R2 sequence alone can&rsquo;t be used to sample directions in the raytracing shader. Since each pixel has the same frame count, each pixel would be using the exact same sequence of &ldquo;random numbers&rdquo;. This results in visual artifacts, such as jittery shadows with bands.</p>
<p>Inspired by the article on <a href="https://link.springer.com/chapter/10.1007/978-1-4842-7185-8_24">Using Blue Noise for Ray Traced Soft Shadows</a>, spatial decorrelation is added to the R2 sequence in the form of <strong>blue noise</strong>. Blue noise is explained in depth in the article, and is well worth a read. Unlike in the article, where a single channel of blue noise is used, and animated using a 1-dimensional R-sequence, I found it easier to work with two-dimensional blue noise and the R2 sequence. That way, I had no issues with the noise even over very large frame counts (<em>n</em>) for both soft shadows as well as sampling the cosine hemispheres.</p>
<p>To recap, the animated noise function has a spatial component (blue noise) and a temporal component (R2 sequence driven by the frame count).</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> animatedBlueNoise(coord: <span style="color:#2b91af">vec2u</span>, frameCount: <span style="color:#2b91af">u32</span>, frameCountCycle: <span style="color:#2b91af">u32</span>) -&gt; <span style="color:#2b91af">vec2f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// Spatial component
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#00f">let</span> idx = (coord.y % blueNoise.height) * blueNoise.width + (coord.x % blueNoise.width);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> blueNoise = blueNoise.data[idx];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// Temporal component
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#00f">let</span> n = frameCount % frameCountCycle;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> a1 = 0.7548776662466927f;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> a2 = 0.5698402909980532f;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> r2Seq = fract(vec2(
</span></span><span style="display:flex;"><span>        a1 * <span style="color:#2b91af">f32</span>(n),
</span></span><span style="display:flex;"><span>        a2 * <span style="color:#2b91af">f32</span>(n)
</span></span><span style="display:flex;"><span>    ));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> fract(blueNoise + r2Seq);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The source of blue noise values is a texture which can be downloaded from <a href="http://momentsingraphics.de/BlueNoise.html">Free blue noise textures</a>. Generating them yourself is tricky. Here&rsquo;s an exmaple of a two-channel blue noise texture that I downloaded. The texture tiles seamlessly, so it can be used even when much smaller than the viewport.</p>
<p><img src="/img/pathtracer_devlog/128_128_LDR_RG01_0.png" alt="blue noise"></p>
<p>The animated blue noise is then leveraged in all the places of the random number generator was previously used: generating the jittered primary ray origins, sampling directions in the cosine-weighted hemisphere, and sampling directions in the sun disk cone.</p>
<p>Here&rsquo;s a comparison of the old white noise versus the new blue noise, at 1 sample per pixel.</p>
<p><em>White noise, 1 spp</em></p>
<p><img src="/img/pathtracer_devlog/white-noise.png" alt="1 spp white noise"></p>
<p><em>Blue noise, 1 spp</em></p>
<p><img src="/img/pathtracer_devlog/blue-noise.png" alt="1 spp blue noise"></p>
<p>I hope the difference is apparent. I find the spatial distribution of blue noise to be much more pleasant.</p>
<p>At 16 samples per pixel, the difference is again noticeable.</p>
<p><em>White noise, 16 spp</em></p>
<p><img src="/img/pathtracer_devlog/white-noise-16.png" alt="16 spp white noise"></p>
<p><em>Blue noise, 16 spp</em></p>
<p><img src="/img/pathtracer_devlog/blue-noise-16.png" alt="16 spp blue noise"></p>
<p>The animated blue noise results in much better soft shadows, and in slightly less noisy indirect illumination. Bounced light samples have so much variance that the blue noise has a reduced impact compared to soft shadows. But overall, using spatiotemporal blue noise significantly reduces the sample count required to obtain a clean image using the reference path tracer.</p>
<h2 id="deferred-bounced-lighting">Deferred bounced lighting</h2>
<p><em>2024-04-28</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/7526265cf50cb6b7be5a61eb0ac6a64d89bc1394">7526265</a></em></p>
<p>Bounced lighting is added to the deferred render pipeline. The <code>surfaceColor</code> function now contains an identical diffuse sampling step as the reference path tracer. Output is identical to the reference path tracer without any accumulation.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>@must_use
</span></span><span style="display:flex;"><span> <span style="color:#00f">fn</span> surfaceColor(rng: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;, primaryPos: <span style="color:#2b91af">vec3f</span>, primaryNormal: <span style="color:#2b91af">vec3f</span>, primaryAlbedo: <span style="color:#2b91af">vec3f</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>     var position = primaryPos;
</span></span><span style="display:flex;"><span>     var normal = primaryNormal;
</span></span><span style="display:flex;"><span>     var albedo = primaryAlbedo;
</span></span><span style="display:flex;"><span>     var radiance = vec3(0f);
</span></span><span style="display:flex;"><span>     var throughput = vec3(1f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     radiance += throughput * lightSample(rng, position, normal, albedo);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#00f">for</span> (var bounce = 1; bounce &lt; NUM_BOUNCES; bounce += 1) {
</span></span><span style="display:flex;"><span>         <span style="color:#00f">let</span> wi = evalImplicitLambertian(normal, rng);
</span></span><span style="display:flex;"><span>         <span style="color:#00f">let</span> ray = Ray(position, wi);
</span></span><span style="display:flex;"><span>         throughput *= albedo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         var hit: <span style="color:#2b91af">Intersection</span>;
</span></span><span style="display:flex;"><span>         <span style="color:#00f">if</span> rayIntersectBvh(ray, T_MAX, &amp;hit) {
</span></span><span style="display:flex;"><span>             position = hit.p;
</span></span><span style="display:flex;"><span>             normal = hit.n;
</span></span><span style="display:flex;"><span>             <span style="color:#00f">let</span> uv = hit.uv;
</span></span><span style="display:flex;"><span>             <span style="color:#00f">let</span> textureDescriptorIdx = hit.textureDescriptorIdx;
</span></span><span style="display:flex;"><span>             albedo = evalTexture(textureDescriptorIdx, uv);
</span></span><span style="display:flex;"><span>         } <span style="color:#00f">else</span> {
</span></span><span style="display:flex;"><span>             <span style="color:#00f">let</span> v = ray.direction;
</span></span><span style="display:flex;"><span>             <span style="color:#00f">let</span> s = skyState.sunDirection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             <span style="color:#00f">let</span> theta = acos(v.y);
</span></span><span style="display:flex;"><span>             <span style="color:#00f">let</span> gamma = acos(clamp(dot(v, s), -1f, 1f));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             <span style="color:#00f">let</span> skyRadiance = vec3f(
</span></span><span style="display:flex;"><span>                 skyRadiance(theta, gamma, CHANNEL_R),
</span></span><span style="display:flex;"><span>                 skyRadiance(theta, gamma, CHANNEL_G),
</span></span><span style="display:flex;"><span>                 skyRadiance(theta, gamma, CHANNEL_B)
</span></span><span style="display:flex;"><span>             );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             radiance += throughput * skyRadiance;
</span></span><span style="display:flex;"><span>             <span style="color:#00f">break</span>;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         radiance += throughput * lightSample(rng, position, normal, albedo);
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#00f">return</span> radiance;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="support-for-larger-scenes">Support for larger scenes</h2>
<p><em>2024-04-27</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/26030ac0490c801c5cc1898714e50443da93fee6">26030ac</a></em></p>
<p>A number of changes have been made over the last few weeks to support the loading and rendering of additional, larger, scenes.</p>
<ul>
<li><a href="https://github.com/Nelarius/rayfinder/commit/26030ac0490c801c5cc1898714e50443da93fee6">Make positionOffset more conservative to help with larger scenes</a>. In order to fight some remaining z-fighting which occurs in the distance of large open spaces, the position offset from the intersected geometry is made more conservative than before.</li>
<li><a href="https://github.com/Nelarius/rayfinder/commit/a27f10c8c8f5ab20d17bdeb194e3fdd8d2f85ecf">Load single pixel textures</a>. The San Miguel courtyard scene contains single pixel textures, stored in the <code>&quot;baseColorFactor&quot;</code> field in glTF.</li>
<li><a href="https://github.com/Nelarius/rayfinder/commit/221884f03d90e5ae6d1e0c172c1f78392002ba6a">Increase GPU limits to unconstrain size of resources that can be used</a>. The San Miguel and Rungholt minecraft scene both contain close to a gigabyte of geometry and textures. The GPU adapter limits are increased to accommodate the new scene sizes.
<ul>
<li>Related: <a href="https://github.com/Nelarius/rayfinder/commit/4389072d350746e14c6eb075963c85db2024b90d">Throw exception when gpu buffer fails to map on creation</a>. Improved error reporting when a memory map request occurs over the device buffer size limit.</li>
</ul>
</li>
<li><a href="https://github.com/Nelarius/rayfinder/commit/d6351d0b4035bd4273eb1f7c7f9a11c999e1d4f6">Bump dawn to chromium/6385</a>. The latest version of Dawn fixes some Vulkan allocator OOM errors which occur when creating buffers within the new, larger, device limits.</li>
</ul>
<p>New scenes: <a href="https://github.com/nelarius/rayfinder-assets">rayfinder-assets</a>.</p>
<p><em>san-miguel-low-poly.glb</em></p>
<p><img src="/img/pathtracer_devlog/san-miguel-low-poly.png" alt="san-miguel-low-poly"></p>
<p><em>rungholt.glb</em></p>
<p><img src="/img/pathtracer_devlog/rungholt.png" alt="rungholt"></p>
<h2 id="deferred-direct-lighting">Deferred direct lighting</h2>
<p><em>2024-04-22</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/2f59399c28c27245ec19d247bd638281909ca41b">2f59399</a></em></p>
<p>Direct lighting is added to the lighting pass. The primary ray intersection with the scene is reconstructed from the gbuffers using a slightly modified version of the function from the previous entry.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> worldFromUv(uv: <span style="color:#2b91af">vec2f</span>, depthSample: <span style="color:#2b91af">f32</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> ndc = vec4(2.0 * vec2(uv.x, 1.0 - uv.y) - vec2(1.0), depthSample, 1.0);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> worldInvW = uniforms.inverseViewReverseZProjectionMat * ndc;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> world = worldInvW / worldInvW.w;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> world.xyz;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The surface normal and the albedo are looked up as-is from their respective buffers.</p>
<p>The direct lighting contribution for each pixel is obtained by tracing a ray to the sun disk and testing for visibility. This snippet is identical to the direct lighting contribution from the &ldquo;next event estimation&rdquo; contribution in the reference path tracer.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> surfaceColor(rng: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;, pos: <span style="color:#2b91af">vec3f</span>, normal: <span style="color:#2b91af">vec3f</span>, albedo: <span style="color:#2b91af">vec3f</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> lightDirection = sampleSolarDiskDirection(
</span></span><span style="display:flex;"><span>        SOLAR_COS_THETA_MAX, skyState.sunDirection, rng);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> lightIntensity = vec3(
</span></span><span style="display:flex;"><span>        skyState.solarRadiances[CHANNEL_R],
</span></span><span style="display:flex;"><span>        skyState.solarRadiances[CHANNEL_G],
</span></span><span style="display:flex;"><span>        skyState.solarRadiances[CHANNEL_B]
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> brdf = albedo * FRAC_1_PI;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> reflectance = brdf * dot(normal, lightDirection);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> lightVisibility = shadowRay(Ray(pos, lightDirection), T_MAX);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> lightIntensity * reflectance * lightVisibility * SOLAR_INV_PDF;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>This results in the following image with harsh, direct, sun light. Indirect light or sky dome light is not visible since no bounce rays are being traced yet.</p>
<p><img src="/img/pathtracer_devlog/deferred-direct-light.png" alt="deferred direct light"></p>
<p><strong>Solving z-fighting issues with the depth buffer</strong></p>
<p>The direct lighting didn&rsquo;t work completely out of the box. Very visible z-fighting occurred, presumably the sun visibility ray self-intersecting with the scene geometry due to the world space coordinate calculated from the depth buffer lacking precision.</p>
<p><img src="/img/pathtracer_devlog/self-intersection.png" alt="self-intersection"></p>
<p>The <a href="https://www.reedbeta.com/blog/depth-precision-visualized/">Depth Precision Visualized</a> is a great visual explanation of depth buffer precision problems.</p>
<p>There were two ways to solve the problem:</p>
<ol>
<li>Choosing a larger near plane value to reduce the steepness of the \(1/z\) asymptote.</li>
<li>Reversing the near and far plane, i.e. <em>reverse Z projection</em>.</li>
</ol>
<p>Moving the near plane a bit further away from zero (from <code>0.1</code> to <code>&gt; 0.5</code>) actually solved the z-fighting issue, but also caused visible clipping when moving around the Sponza scene.</p>
<p>Reverse Z projection is implemented, in the three steps mentiond in <a href="https://tomhultonharrop.com/mathematics/graphics/2023/08/06/reverse-z.html">this blog post</a> (depth comparison function to greater instead of less, clear the depth buffer with 0 instead of 1, and multiply the projection matrix with the reverse-z matrix to flip the planes).</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>glm::mat4 FlyCameraController::viewReverseZProjectionMatrix() <span style="color:#00f">const</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">const</span> glm::mat4 reverseZ = glm::mat4(1.0f, 0.0f,  0.0f, 0.0f,
</span></span><span style="display:flex;"><span>                                         0.0f, 1.0f,  0.0f, 0.0f,
</span></span><span style="display:flex;"><span>                                         0.0f, 0.0f, -1.0f, 0.0f,
</span></span><span style="display:flex;"><span>                                         0.0f, 0.0f,  1.0f, 1.0f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">const</span> <span style="color:#2b91af">float</span>     near = 0.1f;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">const</span> <span style="color:#2b91af">float</span>     far = 1000.0f;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">const</span> glm::mat4 project =
</span></span><span style="display:flex;"><span>        glm::perspective(mVfov.asRadians(), aspectRatio(mWindowSize), near, far);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">const</span> glm::mat4 view = glm::lookAt(origin, lookAt, up);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> reverseZ * project * view;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="rendering-the-sky-and-albedo-in-a-deferred-render-pass">Rendering the sky and albedo in a deferred render pass</h2>
<p><em>2024-03-31</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/41ee49872d075746d69084ad242f622e37b9e389">41ee498</a></em></p>
<p>The <code>HybridRenderer</code> is renamed <code>DeferredRenderer</code> as that is a more frequently used term in this log and literature.</p>
<p>A new deferred <em>lighting pass</em> is introduced. The sky and gbuffer&rsquo;s albedo channel is rendered as a proof of concept.</p>
<p>The shader renders a full-screen quad to the screen and uses the screen&rsquo;s UV-coordinates to calculate the pixel&rsquo;s camera ray direction as well as the texture index to read a pixel from the albedo texture. The depth buffer value is used to test whether the pixel overlaps geometry or the sky. The sentinel value of <code>1.0</code> is what the depth buffer was cleared with and indicates that the pixel did not contain geometry.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#008000">// fragment shader body
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>var color = vec3f(0.0, 0.0, 0.0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> uv = <span style="color:#00f">in</span>.texCoord;
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> idx = vec2u(floor(uv * uniforms.framebufferSize));
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> d = textureLoad(gbufferDepth, idx, 0);
</span></span><span style="display:flex;"><span><span style="color:#00f">if</span> d == 1.0 {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> world = worldFromUv(uv);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> v = normalize((world - uniforms.cameraEye).xyz);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> s = skyState.sunDirection;
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// This is equivalent to path tracer code
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#00f">let</span> theta = acos(v.y);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> gamma = acos(clamp(dot(v, s), -1f, 1f));
</span></span><span style="display:flex;"><span>    color = vec3f(
</span></span><span style="display:flex;"><span>        skyRadiance(theta, gamma, CHANNEL_R),
</span></span><span style="display:flex;"><span>        skyRadiance(theta, gamma, CHANNEL_G),
</span></span><span style="display:flex;"><span>        skyRadiance(theta, gamma, CHANNEL_B)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>} <span style="color:#00f">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> albedo = textureLoad(gbufferAlbedo, idx, 0).rgb;
</span></span><span style="display:flex;"><span>    color = albedo;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The function <code>worldFromUv</code> uses the inverse view projection matrix to calculate near projection plane coordinates from the given UV coordinate. The UV coordinate can be transformed into a normalized device coordinate \(\mathbf{x}_{ndc}\) on the camera frustum&rsquo;s near plane, but it will be scaled by \(1 / w\) value from the divide-by-w step:</p>
<p>$$
\begin{bmatrix}
{x} / {w_0} \\
{y} / {w_0} \\
{z} / {w_0} \\
{1} / {w_0}
\end{bmatrix}
= (\mathrm{PV})^{-1} \mathbf{x}_{ndc}
$$</p>
<p>We need to divide all values by the vector&rsquo;s <code>w</code> component to obtain the original coordinates before the divide-by-w step.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> worldFromUv(uv: <span style="color:#2b91af">vec2f</span>) -&gt; <span style="color:#2b91af">vec4f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> ndc = vec4(2.0 * vec2(uv.x, 1.0 - uv.y) - vec2(1.0), 0.0, 1.0);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> worldInvW = uniforms.inverseViewProjectionMat * ndc;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> world = worldInvW / worldInvW.w;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> world;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>The lighting pass displays just the albedo and looks a bit dull at the moment.</em>
<img src="/img/pathtracer_devlog/sponza-albedo.png" alt="lighting pass albedo"></p>
<p><em>The path traced result for reference. Note that the sky is exactly the same is in the deferred pass.</em>
<img src="/img/pathtracer_devlog/sponza-reference.png" alt="reference path tracer comparison"></p>
<h2 id="first-steps-towards-a-deferred-renderer-">First steps towards a deferred renderer </h2>
<p><em>2024-03-30</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/3d1c87196b637cf0c78ecbf6ab14dc8f2b0c1884">3d1c871</a></em></p>
<p>A new deferred renderer, the <code>HybridRenderer</code> class, is added alongside the existing path tracer. The deferred renderer will use path tracing for lighting, but it will replace the primary ray-scene intersection with the output of the rasterization pipeline, which is much faster than using a ray tracing.</p>
<p>As of now, the renderer uses the rasterization pipeline to render the geometry into the gbuffer textures. The albedo and normal textures are render attachments of the gbuffer render pass. The position doesn&rsquo;t have it&rsquo;s own distinct texture. Instead, the depth buffer can be reused to calculate the world positions of each pixel.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">struct</span> <span style="color:#2b91af">GbufferOutput</span> {
</span></span><span style="display:flex;"><span>    @location(0) albedo: <span style="color:#2b91af">vec4</span>&lt;<span style="color:#2b91af">f32</span>&gt;,
</span></span><span style="display:flex;"><span>    @location(1) normal: <span style="color:#2b91af">vec4</span>&lt;<span style="color:#2b91af">f32</span>&gt;,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@fragment
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> fsMain(<span style="color:#00f">in</span>: <span style="color:#2b91af">VertexOutput</span>) -&gt; <span style="color:#2b91af">GbufferOutput</span> {
</span></span><span style="display:flex;"><span>    var c = pow(textureSample(texture, textureSampler, <span style="color:#00f">in</span>.texCoord).xyz, vec3(2.2f));
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> GbufferOutput(vec4(c, 1f), vec4(normalize(<span style="color:#00f">in</span>.normal.xyz), 1f));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The locations of the <code>GbufferOutput</code> map to the color attachments array:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00f">const</span> std::array&lt;WGPURenderPassColorAttachment, 2&gt; colorAttachments{
</span></span><span style="display:flex;"><span>            WGPURenderPassColorAttachment{
</span></span><span style="display:flex;"><span>                .nextInChain = <span style="color:#00f">nullptr</span>,
</span></span><span style="display:flex;"><span>                .view = albedoTextureView,
</span></span><span style="display:flex;"><span>                .depthSlice = WGPU_DEPTH_SLICE_UNDEFINED,
</span></span><span style="display:flex;"><span>                .resolveTarget = <span style="color:#00f">nullptr</span>,
</span></span><span style="display:flex;"><span>                .loadOp = WGPULoadOp_Clear,
</span></span><span style="display:flex;"><span>                .storeOp = WGPUStoreOp_Store,
</span></span><span style="display:flex;"><span>                .clearValue = WGPUColor{0.0, 0.0, 0.0, 1.0},
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            WGPURenderPassColorAttachment{
</span></span><span style="display:flex;"><span>                .nextInChain = <span style="color:#00f">nullptr</span>,
</span></span><span style="display:flex;"><span>                .view = normalTextureView,
</span></span><span style="display:flex;"><span>                .depthSlice = WGPU_DEPTH_SLICE_UNDEFINED,
</span></span><span style="display:flex;"><span>                .resolveTarget = <span style="color:#00f">nullptr</span>,
</span></span><span style="display:flex;"><span>                .loadOp = WGPULoadOp_Clear,
</span></span><span style="display:flex;"><span>                .storeOp = WGPUStoreOp_Store,
</span></span><span style="display:flex;"><span>                .clearValue = WGPUColor{0.0, 0.0, 0.0, 1.0},
</span></span><span style="display:flex;"><span>            }};
</span></span></code></pre></td></tr></table>
</div>
</div><p>A debug renderer is also added which shows the three buffers side by side. The depth buffer is displayed without actually transforming the coordinates back to world space &ndash; at this stage it&rsquo;s possible to visually assert that the textures are being bound correctly to the shader.</p>
<p><img src="/img/pathtracer_devlog/gbuffer-debug-view.png" alt="gbuffer debug"></p>
<h2 id="gallery-of-failures">Gallery of failures</h2>
<p><em>2024-03-29</em></p>
<p>A small break from the usual progress entries. Instead, two images from unsuccesful attempts to render a 3d model using the regular rasterization pipeline.</p>
<p><em>Umm, was I supposed to use an index buffer to access the vertices?</em>
<img src="/img/pathtracer_devlog/deconstructed-duck.png" alt="deconstructed model"></p>
<p><em>The model textures are BGRA8Unorm, not RGBA8Unorm, aren&rsquo;t they?</em>
<img src="/img/pathtracer_devlog/blue-duck.png" alt="blue model"></p>
<h2 id="copying-shader-source-files-into-a-string-at-build-time">Copying shader source files into a string at build time</h2>
<p><em>2024-03-22</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/a5207ab4efa3b37af9c4a52f9fa6ebb0bc59977e">a5207ab</a></em></p>
<p>A method for copying WGSL shader source automatically into a C-string is implemented. The shader source files are listed in the main <code>CMakeLists.txt</code>:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set(<span style="color:#a31515">WGSL_SHADER_FILES</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a31515">reference_path_tracer.wgsl</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a31515">texture_blit.wgsl</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a31515">hybrid_renderer_gbuffer_pass.wgsl</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a31515">hybrid_renderer_debug_pass.wgsl</span>)<span style="">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The custom target <code>bake-wgsl</code> copies each source file&rsquo;s content into a string in the <code>pt/shader_source.hpp</code> header file. The main <code>pt</code> target depends on the <code>bake-wgsl</code> target so that every time a build occurs, <code>shader_source.hpp</code> is updated. This makes it possible to edit shaders in separate source files with the benefits of the wgsl-analyzer plugin.</p>
<p>The custom target depends on a custom command which outputs the header file. The custom command is implemented as a separate cmake script, so that it can be called from the custom command.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>include(<span style="color:#a31515">cmake/BakeWgslSource.cmake</span>)<span style="">
</span></span></span><span style="display:flex;"><span><span style=""></span>add_custom_command(
</span></span><span style="display:flex;"><span>    <span style="color:#a31515">OUTPUT</span> ${SHADER_SOURCE_HEADER_FILE}
</span></span><span style="display:flex;"><span>    <span style="color:#a31515">COMMAND</span> ${CMAKE_COMMAND} <span style="color:#a31515">-DCALL_BAKE_WGSL_SOURCE=1</span> <span style="color:#a31515">-DOUTPUT_FILE=</span>${SHADER_SOURCE_HEADER_FILE} <span style="color:#a31515">-DWGSL_FILES=</span><span style="color:#a31515">&#34;${WGSL_SHADER_FILES}&#34;</span> <span style="color:#a31515">-P</span> ${CMAKE_SOURCE_DIR}<span style="color:#a31515">/cmake/BakeWgslSource.cmake</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a31515">COMMENT</span> <span style="color:#a31515">&#34;Generating ${SHADER_SOURCE_HEADER_FILE} from .wgsl files&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a31515">WORKING_DIRECTORY</span> ${CMAKE_SOURCE_DIR}
</span></span><span style="display:flex;"><span>)<span style="">
</span></span></span><span style="display:flex;"><span><span style=""></span>add_custom_target(<span style="color:#a31515">bake-wgsl</span> <span style="color:#a31515">DEPENDS</span> ${SHADER_SOURCE_HEADER_FILE})<span style="">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="depth-of-field-using-the-thin-lens-approximation">Depth of field using the thin lens approximation</h2>
<p><em>2024-01-14</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/0b77f54941e9ee1ff307c2a13700957f17f458fd">0b77f54</a></em></p>
<p>The thin lens approximation is implemented. The thin lens approximation models a simple lens with an aperture, allowing generating convincing looking depth of field effects.</p>
<p>The thin lens approximation uses the following coordinate system. Normally, rays are generated at <em>origin</em>, and point at each pixel on the image plane (the plane with <em>lower left corner</em>). Using the thin lens approximation, rays are generated randomly in a disk about <em>origin</em> with a <em>lens radius</em>. This approximates the behavior of a ray of light passing through a lens aperture through the focal point, just reversed from a real lens; the focal point is in front of the lens, instead of behind it.</p>
<p><img src="/img/pathtracer_devlog/camera-coordinates.jpg" alt="camera-coordinate-system"></p>
<p>This is how ray generation works in the shader:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> generateCameraRay(camera: <span style="color:#2b91af">Camera</span>, rngState: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;, u: <span style="color:#2b91af">f32</span>, v: <span style="color:#2b91af">f32</span>) -&gt; <span style="color:#2b91af">Ray</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> randomPointInLens = camera.lensRadius * rngNextVec2InUnitDisk(rngState);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> lensOffset = randomPointInLens.x * camera.right + randomPointInLens.y * camera.up;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> origin = camera.origin + lensOffset;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> direction = normalize(camera.lowerLeftCorner
</span></span><span style="display:flex;"><span>                              + u * camera.horizontal
</span></span><span style="display:flex;"><span>                              + v * camera.vertical
</span></span><span style="display:flex;"><span>                              - origin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> Ray(origin, direction);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>UI controls are added which allow the selection of the lens radius, as well as the focus distance. In order to get accurate focus on e.g. the lion&rsquo;s eye, &ldquo;click to focus&rdquo; is also implemented, which calculates the focus distance to the point under the mouse cursor. This is implemented by retaining the BVH in the CPU program, and doing a ray-BVH intersection test by generating a ray at the mouse coordinates.</p>
<p><img src="/img/pathtracer_devlog/dof-lion.png" alt="lion with depth of field"></p>
<p><img src="/img/pathtracer_devlog/dof-atrium.png" alt="sponza atrium with depth of field"></p>
<h2 id="adding-atmospheric-turbidity-controls">Adding atmospheric turbidity controls</h2>
<p><em>2024-01-07</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/e0fe5f4f732959d7b24fce75da6c1c7ac56ed49f">e0fe5f4</a></em></p>
<p>The updated sky model interpolates between the different sky and solar radiances at different atmospheric turbidities. A UI control is added to allow the selection of different turbidity values to see their effect on the image.</p>
<p>A turbidity of 1 corresponds to a very clear sky. The sun is very bright compared to the sky dome. With a turbidity of 10, a large quantity of light from the sun of all wavelengths is scattered. The sky is less blue as a result, and the sunlight&rsquo;s intensity is much smaller. The effect looks a bit like an overcast day.</p>
<p>Turbidity 1:</p>
<p><img src="/img/pathtracer_devlog/turbidity-1.png" alt="turbidity-1"></p>
<p>Turbidity 7:</p>
<p><img src="/img/pathtracer_devlog/turbidity-7.png" alt="turbidity-7"></p>
<p>Turbidity 10:</p>
<p><img src="/img/pathtracer_devlog/turbidity-10.png" alt="turbidity-10"></p>
<h2 id="adding-physically-motivated-sunlight-to-the-scene-">Adding physically-motivated sunlight to the scene </h2>
<p><em>2024-01-01</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/7f69e97c4403c0a71dbe5f51a25ecacf035b79b4">7f69e97</a></em></p>
<p>Physically-motivated sun disk radiance is added to the scene.</p>
<p>The original sample code from the <a href="https://cgg.mff.cuni.cz/projects/SkylightModelling/">Sky Dome Appearance Project</a> is added to the pathtracer project. The sky dome model contains a code path for calculating sunlight. The model provides spectral radiance across the sun disk.</p>
<p>In order to incorporate the sun into the pathtracer, the sun disk spectral radiances need to be converted to RGB values. Spectral radiance \(L\) can be converted to CIE XYZ values using integrals with published <em>color matching functions</em> (CMFs):</p>
<p>$$
X = \int_{\lambda} L(\lambda)\bar{x}(\lambda) d \lambda
$$
$$
Y = \int_{\lambda} L(\lambda)\bar{y}(\lambda) d \lambda
$$
$$
Z = \int_{\lambda} L(\lambda)\bar{z}(\lambda) d \lambda
$$</p>
<p>The following image illustrates the integration of the spectral radiances with the CMFs for the XYZ color space:</p>
<p><img src="/img/pathtracer_devlog/xyz-cmfs.png" alt="xyz-color-matching-functions"></p>
<p>C code from the <a href="https://jcgt.org/published/0002/02/01/">Simple Analytic Approximations to the CIE XYZ Color Matching Functions</a> paper was used to implement simple multi-lobe Gaussian fits for the CIE XYZ CMFs.</p>
<p>The sky dome model is used to generate solar radiances across the entire sun disk at 10 different turbidities. The spectral radiance and CMF product is integrated using the trapezoidal method for each XYZ component.</p>
<p><img src="/img/pathtracer_devlog/sundisk-radiances.png" alt="sundisk-radiances"></p>
<p><em>Technical note</em>: the sun disks contain a bright spot, which I didn&rsquo;t spend time on figuring out yet. The model implementation appears to be a bit incomplete and therefore some issues might remain. Since averages are computed across the sun disk anyway, the bright spot does not affect the computed radiance very much.</p>
<p>For each turbidity, the solar radiance is converted to XYZ, then to sRGB primaries. The XYZ to sRGB conversion matrix was obtained <a href="http://www.brucelindbloom.com/index.html?Eqn_RGB_XYZ_Matrix.html">here</a>. The mean of the sRGB primaries is computed and used as a proxy of the solar radiance over the sun disk. The <code>hw-skymodel</code> library interpolates between these mean RGB solar radiances to account for the different solar intensities at different atmospheric turbidities.</p>
<p>The solar radiance can now be generated along with the sky dome radiance.</p>
<p><img src="/img/pathtracer_devlog/hw-skymodel-with-sundisk.png" alt="hw-skymodel-with-sundisk"></p>
<p>The earlier, hard-coded <code>lightIntensity</code> value is now replaced with the computed mean RGB solar radiance.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">let</span> lightIntensity = vec3(
</span></span><span style="display:flex;"><span>    skyState.solarRadiances[CHANNEL_R],
</span></span><span style="display:flex;"><span>    skyState.solarRadiances[CHANNEL_G],
</span></span><span style="display:flex;"><span>    skyState.solarRadiances[CHANNEL_B]
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>This results in a more beautiful yellowish lighting in the scene.</p>
<p><img src="/img/pathtracer_devlog/sponza-pbs-1.png" alt="sponza-pbs-1"></p>
<p><img src="/img/pathtracer_devlog/sponza-pbs-2.png" alt="sponza-pbs-2"></p>
<p><em>Technical note</em>: in the actual pathtracer shader, the sky dome radiance code path skips the sun disk radiance. This means that the sun disk is not visible in the sky in images produced by the pathtracer. Including the sun disk radiance when the ray scatters into the sky results in images with fireflies. This is likely due to some very rare rays which eventually hit the sun disk directly with large weights.</p>
<p><img src="/img/pathtracer_devlog/sponza-fireflies.png" alt="sponza-fireflies"></p>
<h2 id="quick-color-encoding-fix">Quick color encoding fix</h2>
<p><em>2023-12-30</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/883ed07b0012b6a9fea913d081de8d289311c82a">883ed07</a></em></p>
<p>Two issues with color encoding are fixed.</p>
<ul>
<li>Textures stored in image files typically contain a standard non-linear gamma ramp, and need to be converted to linear values during sampling. Non-linear RGB values cannot be mutually added or multiplied, so the color calculations have not been correct up until now.</li>
<li>The frame buffer&rsquo;s texture format is <code>WGPUTextureFormat_BGRA8Unorm</code> and a gamma ramp must be applied to the final image output colors.</li>
</ul>
<p>The duck without the sun &ndash; the image appears less washed out than before.</p>
<p><img src="/img/pathtracer_devlog/duck-srgb.png" alt="duck-srgb"></p>
<p>The difference in the Sponza scene is less pronounced, but the shadows seem to be a bit brighter than before.</p>
<p><img src="/img/pathtracer_devlog/sponza-srgb.png" alt="sponza-srgb"></p>
<h2 id="adding-sunlight-to-the-scene">Adding sunlight to the scene</h2>
<p><em>2023-12-28</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/70624a796d7351c100ac5652159f3527e00f43f6">70624a7</a></em></p>
<p>Previously, the Sponza scene has appeared rather dimly lit. The sky dome acts like a giant diffuse light source, since the sky dome model used does not actually contain a sun disk, the main light source.</p>
<p>The sun disk&rsquo;s angular radius is 0.255 degrees, which means that it occupies so little space in the sky that few rays would actually hit it with random chance. The &ldquo;Next Event Estimation&rdquo; method is implemented to sample the sun efficiently. The method samples the sun disk on every ray-triangle intersection and evaluates the material&rsquo;s BRDF to accumulate the sun&rsquo;s radiance at every ray bounce. The sun&rsquo;s direct illumination is used as indirect illumination in the following bounces.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">loop</span> {
</span></span><span style="display:flex;"><span>    var hit: <span style="color:#2b91af">Intersection</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">if</span> rayIntersectBvh(ray, T_MAX, &amp;hit) {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">let</span> albedo = evalTexture(hit.textureDescriptorIdx, hit.uv);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">let</span> p = hit.p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#008000">// Sample a random direction towards the sun disk.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        <span style="color:#00f">let</span> lightDirection = sampleSolarDiskDirection(
</span></span><span style="display:flex;"><span>                SOLAR_COS_THETA_MAX, skyState.sunDirection, rngState);
</span></span><span style="display:flex;"><span>        <span style="color:#008000">// Hard-coded sun radiance with plausible magnitude.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        <span style="color:#00f">let</span> lightIntensity = vec3f(1000000f, 1000000f, 1000000f);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">let</span> brdf = albedo * FRAC_1_PI;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">let</span> reflectance = brdf * dot(hit.n, lightDirection);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">let</span> lightVisibility = shadowRay(Ray(p, lightDirection), T_MAX);
</span></span><span style="display:flex;"><span>        radiance += throughput * lightIntensity * reflectance *
</span></span><span style="display:flex;"><span>                    lightVisibility * SOLAR_INV_PDF;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// The rest of the rendering loop as before
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>sampleSolarDiskDirection</code> is based on the sampling transformation function presented in <em>Sampling Transformations Zoo</em>, <em>Ray Tracing Gems</em>. It generates random directions in a cone, subtended by a disk with an angular radius, \(\theta_{\mathrm{max}}\). The directions have to be transformed into the sun&rsquo;s direction, using the <code>pixarOnb</code> orthonormal basis function.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> rngNextInCone(state: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;, cosThetaMax: <span style="color:#2b91af">f32</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> u1 = rngNextFloat(state);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> u2 = rngNextFloat(state);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> cosTheta = 1f - u1 * (1f - cosThetaMax);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> sinTheta = sqrt(1f - cosTheta * cosTheta);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> phi = 2f * PI * u2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> x = cos(phi) * sinTheta;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> y = sin(phi) * sinTheta;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> z = cosTheta;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> vec3(x, y, z);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/pathtracer_devlog/uniform-cone-distribution.png" alt="uniform-cone-distribution"></p>
<p>The value of <code>lightIntensity</code> is a very large value, with a roughly plausible order of magnitude, which results in a good looking image. In the future it could be derived from a physically based model of the sun.</p>
<p><img src="/img/pathtracer_devlog/sponza-nee-1.png" alt="sponza-nee-1"></p>
<p><img src="/img/pathtracer_devlog/sponza-nee-2.png" alt="sponza-nee-2"></p>
<p>Finally, here&rsquo;s a picture of what the Sponza palace looks like in real life, from a picture that I took when I visited there in 2022.</p>
<p><img src="/img/pathtracer_devlog/sponza-irl.jpg" alt="sponza-irl"></p>
<h2 id="implementing-tiled-texture-support">Implementing tiled texture support</h2>
<p><em>2023-12-24</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/e190c51f8ecdcb0338a1a4c87b7c7b65d95eacd9">e190c51</a></em></p>
<p>In the <a href="/post/pathtracer_devlog/#simple-texture-support-">Simple texture support</a> section, an apparent texture issue with the Sponza atrium scene was highlighted. On further investigation, the 3d model&rsquo;s texture coordinates were not contained in the [0, 1] range, which is what my texture sampler assumes. To look correct, the model assumes tiled texture coordinate support in the renderer. The texture coordinate is supposed to wrap around back to zero at a regular interval.</p>
<p>The issue can be clearly seen in the corners of the model where the texture is displayed correctly once, and then gets stretched out as the texture coordinate fails to wrap around.</p>
<p><img src="/img/pathtracer_devlog/tiled-texture-artifact.png" alt="tiled-texture-artifact"></p>
<p>In glTF, by default, textures are assumed to be sampled using OpenGL&rsquo;s <code>GL_REPEAT</code> behavior. This can be confirmed by observing <code>cgltf_texture::sampler::wrap_s</code> and <code>wrap_t</code> values:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#008000">// Look up OpenGL texture wrap mode magic numbers:
</span></span></span><span style="display:flex;"><span><span style="color:#008000">// https://registry.khronos.org/OpenGL/api/GL/glcorearb.h
</span></span></span><span style="display:flex;"><span><span style="color:#008000">// GL_REPEAT: 10497
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>assert(baseColorTexture.sampler-&gt;wrap_s == 10497);
</span></span><span style="display:flex;"><span>assert(baseColorTexture.sampler-&gt;wrap_t == 10497);
</span></span></code></pre></td></tr></table>
</div>
</div><p>The OpenGL spec says that</p>
<ul>
<li><code>GL_REPEAT</code> causes the integer part of the s coordinate to be ignored;
the GL uses only the fractional part, thereby creating a repeating pattern.</li>
</ul>
<p>To mimic <code>GL_REPEAT</code> behavior, the UV coordinates are passed through the <code>fract</code> function during texture lookup:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> textureLookup(desc: <span style="color:#2b91af">TextureDescriptor</span>, uv: <span style="color:#2b91af">vec2f</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> u = fract(uv.x);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> v = fract(uv.y);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// .. the rest of the function as before
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>With this simple change, the Sponza scene looks correct and it finally feels right to give it the path tracer treatment.</p>
<p><img src="/img/pathtracer_devlog/sponza-fixed.png" alt="sponza-fixed"></p>
<h2 id="avoiding-triangle-self-intersection">Avoiding triangle self-intersection</h2>
<p><em>2023-12-17</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/9183d425ebefda1b18e1ea4ed640f5b12c3fbf45">9183d42</a></em></p>
<p>It&rsquo;s possible for the ray-triangle intersection point to be below the triangle if one isn&rsquo;t careful, resulting in the next ray self-intersecting the triangle. The method from <em>A Fast and Robust Method for Avoiding Self-Intersection</em>, <em>Ray Tracing Gems</em> is implemented. It contains two parts.</p>
<p>First, the intersection point should be computed using barycentric coordinates, instead of the ray equation, to avoid precision issues due to the difference in magnitude of the ray origin and the distance.</p>
<p>Second, the intersection point is offset from the surface of the triangle using the following <code>offsetRay</code> function. It offsets using a conservative estimate of the precision error, accounting for the scale of the intersection point.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">const</span> ORIGIN = 1f / 32f;
</span></span><span style="display:flex;"><span><span style="color:#00f">const</span> FLOAT_SCALE = 1f / 65536f;
</span></span><span style="display:flex;"><span><span style="color:#00f">const</span> INT_SCALE = 256f;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> offsetRay(p: <span style="color:#2b91af">vec3f</span>, n: <span style="color:#2b91af">vec3f</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> offset = vec3i(<span style="color:#2b91af">i32</span>(INT_SCALE * n.x), <span style="color:#2b91af">i32</span>(INT_SCALE * n.y), <span style="color:#2b91af">i32</span>(INT_SCALE * n.z));
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// Offset added straight into the mantissa bits to ensure the offset is scale-invariant,
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">// except for when close to the origin, where we use FLOAT_SCALE as a small epsilon.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#00f">let</span> po = vec3f(
</span></span><span style="display:flex;"><span>        bitcast&lt;<span style="color:#2b91af">f32</span>&gt;(bitcast&lt;<span style="color:#2b91af">i32</span>&gt;(p.x) + select(offset.x, -offset.x, (p.x &lt; 0))),
</span></span><span style="display:flex;"><span>        bitcast&lt;<span style="color:#2b91af">f32</span>&gt;(bitcast&lt;<span style="color:#2b91af">i32</span>&gt;(p.y) + select(offset.y, -offset.y, (p.y &lt; 0))),
</span></span><span style="display:flex;"><span>        bitcast&lt;<span style="color:#2b91af">f32</span>&gt;(bitcast&lt;<span style="color:#2b91af">i32</span>&gt;(p.z) + select(offset.z, -offset.z, (p.z &lt; 0)))
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> vec3f(
</span></span><span style="display:flex;"><span>        select(po.x, p.x + FLOAT_SCALE * n.x, (abs(p.x) &lt; ORIGIN)),
</span></span><span style="display:flex;"><span>        select(po.y, p.y + FLOAT_SCALE * n.y, (abs(p.y) &lt; ORIGIN)),
</span></span><span style="display:flex;"><span>        select(po.z, p.z + FLOAT_SCALE * n.z, (abs(p.z) &lt; ORIGIN)));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="filmic-tone-mapping-and-better-tone-mapping-controls">Filmic tone mapping and better tone mapping controls</h2>
<p><em>2023-12-03</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/37bfce8d9c4c4e838d67e885305fa764be7b6fa2">37bfce8</a></em></p>
<p>The <code>expose</code> function from the previous entry was not a very good tonemapping curve and was baked into the raytracing shader.</p>
<p>The <a href="https://knarkowicz.wordpress.com/2016/01/06/aces-filmic-tone-mapping-curve/">ACES filmic tone mapping curve</a> is a curve fit of a complex tone mapping algorithm used in the film industry and looks better than the curve used previously.</p>
<p>A simple exposure control multiplier is introduced, defined in terms of <em>stops</em>.</p>
<p>$$
\mathrm{exposure} = \frac{1}{2^{\mathrm{stop}}}, \mathrm{stop} \geq 0.
$$</p>
<p>The exposure is halved each time the stop is incremented. The Monte Carlo estimator is scaled by the exposure multiplier and passed through the tone mapping function, which yields the final value.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">let</span> stops = <span style="color:#2b91af">f32</span>(postProcessingParams.stops);
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> exposure = 1f / pow(2f, stops);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000">// tonemapFn is an enumeration with linear = 0, filmic = 1.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span><span style="color:#00f">let</span> tonemapFn = postProcessingParams.tonemapFn;
</span></span><span style="display:flex;"><span><span style="color:#00f">let</span> rgb = expose(tonemapFn, exposure * estimator);
</span></span></code></pre></td></tr></table>
</div>
</div><p>A linear tone map with <em>stops</em> = 4 yields the following image.</p>
<p><img src="/img/pathtracer_devlog/linear-mapping.png" alt="linear tonemapping"></p>
<p>Filmic tone map with <em>stops</em> = 4 yields a much better looking image.</p>
<p><img src="/img/pathtracer_devlog/filmic-mapping.png" alt="ACES filmic tonemapping"></p>
<h2 id="integrating-a-physically-based-sky-model">Integrating a physically-based sky model</h2>
<p><em>2023-11-20</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/c0403255afe3a7bec244fc51c533ae5e1d7c75e0">c040325</a></em></p>
<p>The Hosek-Wilkie sky model is integrated in the renderer. The model implementation is a straightforward C-port of the <a href="https://github.com/phoekz/hw-skymodel">hw-skymodel</a> Hosek-Wilkie model implementation.</p>
<p>The model provides physically-based radiance values for any direction in the sky, assuming the viewer is on the ground of the Earth. The model was obtained by doing brute-force simulations of the atmospheric scattering process on Earth, and then fitting the results into a simple model that is much faster to evaluate at runtime.</p>
<p>The sky model parameters, such as the sun&rsquo;s position, can be updated in real-time. This involves recomputing the values in a look-up table, and uploading them to the GPU. The look-up table values are used to compute the radiance for each ray which scatters towards the sky:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">for</span> (var bounces = 0u; bounces &lt; NUM_BOUNCES; bounces += 1u) {
</span></span><span style="display:flex;"><span>    var intersection: <span style="color:#2b91af">Intersection</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">if</span> rayIntersectBvh(ray, T_MAX, &amp;intersection) {
</span></span><span style="display:flex;"><span>        <span style="color:#008000">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    } <span style="color:#00f">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#008000">// Ray missed. Compute sky radiance.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        <span style="color:#00f">let</span> v = ray.direction;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">let</span> s = skyState.sunDirection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">let</span> theta = acos(v.y);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">let</span> gamma = acos(clamp(dot(v, s), -1f, 1f));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">let</span> skyRadiance = vec3f(
</span></span><span style="display:flex;"><span>            radiance(theta, gamma, CHANNEL_R),
</span></span><span style="display:flex;"><span>            radiance(theta, gamma, CHANNEL_G),
</span></span><span style="display:flex;"><span>            radiance(theta, gamma, CHANNEL_B)
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        color += throughput * skyRadiance;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The model does not return RGB color values, but physical radiance values along each ray. These values are much larger than the [0, 1] RGB color range. The following <code>expose</code> function is used to map the radiance values to a valid RGB color:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> expose(v: <span style="color:#2b91af">vec3f</span>, exposure: <span style="color:#2b91af">f32</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> vec3(2.0f) / (vec3(1.0f) + exp(-exposure * v)) - vec3(1.0f);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here is what the full sky dome looks like, rendered about the vertical y-axis.</p>
<p><img src="/img/pathtracer_devlog/sky-dome.jpg" alt="hw sky hemisphere"></p>
<p>The lighting scattering off the duck model also looks distinctly different from before.</p>
<p><img src="/img/pathtracer_devlog/duck-hw-skymodel.png" alt="duck hw sky"></p>
<h2 id="even-better-estimator-simple-temporal-accumulation">Even better estimator: simple temporal accumulation</h2>
<p><em>2023-11-15</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/b10570a058f844032c058bf566e818176118ebea">b10570a</a></em></p>
<p>Temporal accumulation is implemented and the sum term is added back to our Monte Carlo estimator:</p>
<p>$$
F_n = \frac{1}{n} \sum_{i = 1}^{n} k_{\textrm{albedo}}L_i(\omega_i),
$$</p>
<p>1 sample per pixel is accumulated per frame, and our estimator is thus active over multiple frames. If the camera moves, or different rendering parameters are selected, rendering the image starts from scratch.</p>
<p>The duck after 256 samples per pixel:</p>
<p><img src="/img/pathtracer_devlog/temporally-accumulated-duck.png" alt="temporally accumulated samples"></p>
<h2 id="better-estimator-importance-sampling-surface-normal-directions">Better estimator: importance sampling surface normal directions</h2>
<p><em>2023-11-14</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/4a76335aa527d816d766606e7dab774582ed6f8b">4a76335</a></em></p>
<p>Cosine-weighted hemisphere sampling is implemented. The term \((\omega_i \cdot \mathrm{n})\) in the rendering equation equals \(\cos \theta\), where \(\theta\) is the zenith angle between the surface normal and the incoming ray direction. Directions which are close to perpendicular to the surface normal contribute very little light due to the cosine. It would be better to sample directions close to the surface normal.</p>
<p>The Monte Carlo estimator for non-uniform random variables \(X_i\) drawn out of probability density function (PDF) \(p(x)\) is</p>
<p>$$
F_n = \frac{1}{n} \sum_{i = 1}^{n} \frac{f(X_i)}{p(X_i)}.
$$</p>
<p>Choosing \(p(\omega) = \frac{\cos \theta}{\pi}\) and, like before, taking just one sample, our estimator becomes:</p>
<p>$$
F_1 = \frac{\pi}{\cos \theta} f_{\textrm{lam}}L_i(\omega_i)(\omega_i \cdot \mathrm{n}).
$$</p>
<p>We can substitute \((\omega_i \cdot \mathrm{n}) = \cos \theta\) and \(f_{\textrm{lam}} = \frac{k_{\textrm{albedo}}}{\pi}\) to simplify the estimator further:</p>
<p>$$
F_1 = k_{\textrm{albedo}}L_i(\omega_i),
$$</p>
<p>where our light direction \(\omega_i\) is now drawn out of the cosine-weighted hemisphere. The code is simplified to just one function, which both samples the cosine-weighted direction and evaluates the albedo:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">struct</span> <span style="color:#2b91af">Scatter</span> {
</span></span><span style="display:flex;"><span>    wi: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>    throughput: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> evalImplicitLambertian(hit: <span style="color:#2b91af">Intersection</span>, rngState: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) -&gt; <span style="color:#2b91af">Scatter</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> v = rngNextInCosineWeightedHemisphere(rngState);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> onb = pixarOnb(hit.n);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> wi = onb * v;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> textureDesc = textureDescriptors[textureDescriptorIndices[hit.triangleIdx]];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> uv = hit.uv;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> albedo = textureLookup(textureDesc, uv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> Scatter(wi, albedo);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="inverse-transform-sampling-the-cosine-weighted-unit-hemisphere">Inverse transform sampling the cosine-weighted unit hemisphere.</h3>
<p>The exact same recipe that was used for the unit hemisphere can be followed here to obtain <code>rngNextInCosineWeightedHemisphere</code>. While the recipe used is introduced in <em>Physically Based Rendering</em>, the book does not present this calculation.</p>
<p><strong>Choice of PDF</strong></p>
<p>Set probability density to be \(p(\omega) \propto \cos \theta\).</p>
<p><strong>PDF normalization</strong></p>
<p>Integrate \(p(\omega)\) over hemisphere H again.</p>
<p>$$
\int_H p(\omega) d\omega = \int_{0}^{2 \pi} \int_{0}^{\frac{\pi}{2}} c \cos \theta \sin \theta d\theta d\phi = \frac{c}{2} \int_{0}^{2 \pi} d\phi = 1
$$
$$
\Longrightarrow c = \frac{1}{\pi}
$$</p>
<p><strong>Coordinate transformation</strong></p>
<p>Again, using the result \(p(\theta, , \phi) = \sin \theta p(\omega)\), obtain</p>
<p>$$
p(\theta , \phi) = \frac{1}{\pi} \cos \theta \sin \theta.
$$</p>
<p><strong>\(\theta\)&rsquo;s marginal probability density</strong></p>
<p>$$
p(\theta) = \int_{0}^{2 \pi} p(\theta , \phi) d \phi = \int_{0}^{2 \pi} \frac{1}{\pi} \cos \theta \sin \theta d \phi = 2 \sin \theta \cos \theta.
$$</p>
<p><strong>\(\phi\)&rsquo;s conditional probability density</strong></p>
<p>$$
p(\phi | \theta) = \frac{p(\theta , \phi)}{p(\theta)} = \frac{1}{2 \pi}
$$</p>
<p><strong>Calculate the CDF&rsquo;s</strong></p>
<p>$$
P(\theta) = \int_{0}^{\theta} 2 \cos \theta^{\prime} \sin \theta^{\prime} d \theta^{\prime} = 1 - \cos^2 \theta
$$
$$
P(\phi | \theta) = \int_{0}^{\phi} \frac{1}{2 \pi} d\phi^{\prime} = \frac{\phi}{2 \pi}
$$</p>
<p><strong>Inverting the CDFs in terms of <em>u</em></strong></p>
<p>$$
\cos \theta = \sqrt{1 - u_1} = \sqrt{u_1}
$$</p>
<p>$$
\phi = 2 \pi u_2
$$</p>
<p>where \(u_1 = 1 - u_1\) is substituted again. Converting \(\theta\), \(\phi\) back to Cartesian coordinates, note that \(z = \cos \theta = \sqrt{u_1}\).</p>
<p>$$
x = \sin \theta \cos \phi = \sqrt{1 - u_1} \cos(2 \pi u_2)
$$
$$
y = \sin \theta \sin \phi = \sqrt{1 - u_1} \sin(2 \pi u_2)
$$
$$
z = \sqrt{u_1}
$$</p>
<p>In code:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> rngNextInCosineWeightedHemisphere(state: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> u1 = rngNextFloat(state);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> u2 = rngNextFloat(state);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> phi = 2f * PI * u2;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> sinTheta = sqrt(1f - u1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> x = cos(phi) * sinTheta;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> y = sin(phi) * sinTheta;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> z = sqrt(u1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> vec3(x, y, z);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/pathtracer_devlog/cosine-distribution.png" alt="cosine weighted hemisphere distribution"></p>
<p>Looking at our duck, before:</p>
<p><img src="/img/pathtracer_devlog/pathtraced-duck.png" alt="pathtraced duck"></p>
<p>And after, with cosine-weighted hemisphere sampling:</p>
<p><img src="/img/pathtracer_devlog/cosine-weighted-duck.png" alt="cosine-weighted duck"></p>
<h2 id="the-first-physically-based-pathtracer">The first physically-based pathtracer</h2>
<p><em>2023-11-13</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/c83b83e019a44d102a79b2890ffd7897bf0977d0">c83b83e</a></em></p>
<p>A simple physically-based pathtracer is implemented.  The rendering equation is solved using the following <em>Monte Carlo estimator</em>:</p>
<p>$$
F_1 = 2 \pi f_r(\mathrm{x_i},\omega_i)L_i(\mathrm{x_i},\omega_i)(\omega_i\cdot\mathrm{n}),
$$</p>
<p>where \(2 \pi\) is the surface area of the unit hemisphere, \(f_r\) is the bidirectional reflectance distribution function (BRDF), \(\omega_i\) is the incoming ray direction, and \(L_i\) is the incoming radiance along \(\omega_i\). The estimator is based on the Monte Carlo estimator for \(\int_{a}^{b} f(x) dx\), where the random variable is drawn from a uniform distribution:</p>
<p>$$
F_n = \frac{b-a}{n} \sum_{i=1}^{n} f(X_i),
$$</p>
<p>where \(n=1\) is set for now and a surface area is used instead of the 1-dimensional range.</p>
<p>For simplicity, only the Lambertian BRDF is implemented at this stage, with \(f_{\textrm{lam}}=\frac{k_{\textrm{albedo}}}{\pi}\). Drawing inspiration from <a href="https://boksajak.github.io/files/CrashCourseBRDF.pdf">Crash Course in BRDF implementation</a>, a pair of functions are implemented:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> sampleLambertian(hit: <span style="color:#2b91af">Intersection</span>, rngState: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> v = rngNextInUnitHemisphere(rngState);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> onb = pixarOnb(hit.n);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> onb * v;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> evalLambertian(hit: <span style="color:#2b91af">Intersection</span>, wi: <span style="color:#2b91af">vec3f</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> textureDesc = textureDescriptors[textureDescriptorIndices[hit.triangleIdx]];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> uv = hit.uv;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> albedo = textureLookup(textureDesc, uv);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> albedo * FRAC_1_PI * max(EPSILON, dot(hit.n, wi));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="inverse-transform-sampling-the-unit-hemisphere">Inverse transform sampling the unit hemisphere.</h3>
<p>To obtain <code>rngNextInUnitHemisphere</code>, we can follow a recipe introduced in <em>Physically Based Rendering</em>. Here&rsquo;s a quick summary of the calculation, which is also partially in the book.</p>
<p><strong>The recipe</strong></p>
<p>In order to do Monte Carlo integration, you will need to do inverse transform sampling with your selected probability density function (PDF). Here&rsquo;s the general steps that you need to take to arrive at a function that you can use to draw sampels from.</p>
<ol>
<li>Choose the probability density function.</li>
<li>If the density function is multidimensional, you can compute the marginal density (integrate out one variable), and the conditional density for the other variable.</li>
<li>Calculate the cumulative distribution function (CDF).</li>
<li>Invert the CDFs in terms of the <em>canonical uniform random variable</em>, \(u\).</li>
</ol>
<p><strong>Choice of PDF</strong></p>
<p>Uniform probability density over all directions \(\omega\), \(p(\omega) = c\).</p>
<p><strong>PDF normalization</strong></p>
<p>The integral over the hemisphere H yields the surface area of a hemisphere:</p>
<p>$$
\int_{H} c d \omega = 2 \pi c = 1
$$</p>
<!-- Line breaks are apparently not yet implemented in mathjax 3:
https://github.com/mathjax/MathJax/issues/2312 -->
<p>$$
c = \frac{1}{2 \pi}
$$</p>
<p><strong>Coordinate transformation</strong></p>
<p>Use the result that \(p(\theta, , \phi) = \sin \theta p(\omega)\) to obtain</p>
<p>$$
p(\theta , \phi) = \frac{\sin \theta}{2 \pi}
$$</p>
<p><strong>\(\theta\)&rsquo;s marginal probability density</strong></p>
<p>$$
p(\theta) = \int_{0}^{2 \pi} p(\theta , \phi) d \phi = \int_{0}^{2 \pi} \frac{\sin \theta}{2 \pi} d \phi = \sin \theta
$$</p>
<p><strong>\(\phi\)&rsquo;s conditional probability density</strong></p>
<p>In general, \(\phi\)&rsquo;s probability density would be conditional on \(\theta\) after computing \(\theta\)&rsquo;s marginal density.</p>
<p>$$
p(\phi | \theta) = \frac{p(\theta , \phi)}{p(\theta)} = \frac{1}{2 \pi}
$$</p>
<p><strong>Calculate the CDF&rsquo;s</strong></p>
<p>$$
P(\theta) = \int_{0}^{\theta} \sin \theta^{\prime} d\theta^{\prime} = 1 - \cos \theta
$$</p>
<p>$$
P(\phi | \theta) = \int_{0}^{\phi} \frac{1}{2 \pi} d\phi^{\prime} = \frac{\phi}{2 \pi}
$$</p>
<p><strong>Inverting the CDFs in terms of <em>u</em></strong></p>
<p>$$
\theta = \cos^{-1}(1 - u_1)
$$</p>
<p>$$
\phi = 2 \pi u_2
$$</p>
<p>\(u_1 = 1 - u_1\) can be substituted as it is just another canonical uniform distribution, to obtain</p>
<p>$$
\theta = \cos^{-1}(u_1)
$$</p>
<p>$$
\phi = 2 \pi u_2
$$</p>
<p>Convert \(\theta\) and \(\phi\) back to Cartesian coordinates</p>
<p>$$
x = \sin \theta \cos \phi = \sqrt{1 - u_1^2} \cos(2 \pi u_2)
$$
$$
y = \sin \theta \sin \phi = \sqrt{1 - u_1^2} \sin(2 \pi u_2)
$$
$$
z = u_1
$$</p>
<p>where we used the identity \(\sin \theta = \sqrt{1 - \cos^2 \theta}\). In code:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> rngNextInUnitHemisphere(state: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> u1 = rngNextFloat(state);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> u2 = rngNextFloat(state);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> phi = 2f * PI * u2;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> sinTheta = sqrt(1f - u1 * u1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> x = cos(phi) * sinTheta;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> y = sin(phi) * sinTheta;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> z = u1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> vec3(x, y, z);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>It generates unit vectors, distributed uniformly in a hemisphere about the z axis.</p>
<p><img src="/img/pathtracer_devlog/uniform-distribution.png" alt="uniform hemisphere distribution"></p>
<p>The functions are used in the path-tracing loop as follows:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">const</span> UNIFORM_HEMISPHERE_MULTIPLIER = 2f * PI;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> rayColor(primaryRay: <span style="color:#2b91af">Ray</span>, rngState: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    var ray = primaryRay;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    var color = vec3(0f);
</span></span><span style="display:flex;"><span>    var throughput = vec3(1f);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">for</span> (var bounces = 0u; bounces &lt; NUM_BOUNCES; bounces += 1u) {
</span></span><span style="display:flex;"><span>        var intersection: <span style="color:#2b91af">Intersection</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">if</span> rayIntersectBvh(ray, T_MAX, &amp;intersection) {
</span></span><span style="display:flex;"><span>            <span style="color:#00f">let</span> p = intersection.p;
</span></span><span style="display:flex;"><span>            <span style="color:#00f">let</span> scatterDirection = sampleLambertian(intersection, rngState);
</span></span><span style="display:flex;"><span>            <span style="color:#00f">let</span> scatterThroughput =
</span></span><span style="display:flex;"><span>                UNIFORM_HEMISPHERE_MULTIPLIER * evalLambertian(intersection, scatterDirection);
</span></span><span style="display:flex;"><span>            ray = Ray(p, scatterDirection);
</span></span><span style="display:flex;"><span>            throughput *= scatterThroughput;
</span></span><span style="display:flex;"><span>        } <span style="color:#00f">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#008000">// compute sky color
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>            ...
</span></span><span style="display:flex;"><span>            <span style="color:#00f">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> color;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can now pathtrace our duck. If the noise on the duck exhibits a grid-like pattern, you should open the full-size image as the website scales the images down.</p>
<p><img src="/img/pathtracer_devlog/pathtraced-duck.png" alt="pathtraced duck"></p>
<p>Now that real work is being done in the shader, the performance of Sponza on my M2 Macbook Air is starting to become punishing. Framerates are in the 1-10 FPS range with the depicted image sizes.</p>
<p><img src="/img/pathtracer_devlog/pathtraced-sponza.png" alt="pathtraced sponza"></p>
<h2 id="simple-texture-support-">Simple texture support </h2>
<p><em>2023-11-10</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/8062be7f4a44580d6d83937b34ed57d52f4c5b35">8062be7</a></em></p>
<p>Initial textures support is added. The &ldquo;base color texture&rdquo; from the glTF &ldquo;pbr metallic roughness&rdquo; material is loaded and passed over to the GPU. The same storage buffer approach from my <a href="https://nelari.us/post/weekend_raytracing_with_wgpu_2/#adding-texture-support">Weekend raytracing with wgpu, part 2</a> post is used for texture lookup on the GPU.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#008000">// Each triangle is associated with an index to a texture descriptor, a
</span></span></span><span style="display:flex;"><span><span style="color:#008000">// placeholder for a texture on the GPU.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>@group(2) @binding(4) var&lt;storage, read_write&gt; textureDescriptorIndices: <span style="color:#2b91af">array</span>&lt;<span style="color:#2b91af">u32</span>&gt;;
</span></span><span style="display:flex;"><span><span style="color:#008000">// A texture descriptor contains an offset into the texture buffer, as
</span></span></span><span style="display:flex;"><span><span style="color:#008000">// well as the texture dimensions.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>@group(2) @binding(5) var&lt;storage, read_write&gt; textureDescriptors: <span style="color:#2b91af">array</span>&lt;TextureDescriptor&gt;;
</span></span><span style="display:flex;"><span><span style="color:#008000">// The texture buffer contains textures from all meshes, appended end to end.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>@group(2) @binding(6) var&lt;storage, read_write&gt; textures: <span style="color:#2b91af">array</span>&lt;<span style="color:#2b91af">u32</span>&gt;;
</span></span></code></pre></td></tr></table>
</div>
</div><p>On ray-triangle intersection, the model vertex UV coordinates are interpolated and the color is computed from the corresponding texel.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">if</span> rayIntersectBvh(ray, T_MAX, &amp;intersection, &amp;triangleIdx) {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> textureDesc = textureDescriptors[textureDescriptorIndices[triangleIdx]];
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> b = intersection.b;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> uvs = texCoords[triangleIdx];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> uv = b[0] * uvs[0] + b[1] * uvs[1] + b[2] * uvs[2];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    color = textureLookup(textureDesc, uv);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> textureLookup(desc: <span style="color:#2b91af">TextureDescriptor</span>, uv: <span style="color:#2b91af">vec2f</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> u = clamp(uv.x, 0f, 1f);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> v = clamp(uv.y, 0f, 1f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> j = <span style="color:#2b91af">u32</span>(u * <span style="color:#2b91af">f32</span>(desc.width));
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> i = <span style="color:#2b91af">u32</span>(v * <span style="color:#2b91af">f32</span>(desc.height));
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> idx = i * desc.width + j;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> rgba = textures[desc.offset + idx];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> vec3f(<span style="color:#2b91af">f32</span>(rgba &amp; 0xffu), <span style="color:#2b91af">f32</span>((rgba &gt;&gt; 8u) &amp; 0xffu), <span style="color:#2b91af">f32</span>((rgba &gt;&gt; 16u) &amp; 0xffu)) / 255f;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The duck model from earlier looks more like a rubber duck now.</p>
<p><img src="/img/pathtracer_devlog/textured-duck.png" alt="textured duck"></p>
<p>Sponza looks a bit rough at this stage. Two things need work.</p>
<ul>
<li>The plants in the foreground need transparency support. On intersection, the transparency of the pixel also needs to be accounted for the ray to intersect the triangle.</li>
<li>There is an issue with the textures on the ground and in some places on the walls being stretched out.</li>
</ul>
<p><img src="/img/pathtracer_devlog/sponza-attempt.png" alt="first sponza"></p>
<p>The stretched textures are likely due to a problem with UV coordinate interpolation. Single colors and suspicious red-black color gradients can be seen when coloring the model according to the triangles&rsquo; interpolated UV coordinates.</p>
<p><img src="/img/pathtracer_devlog/uv-coordinate-issue.png" alt="uv coordinate issue"></p>
<h2 id="interpolated-normals-texture-coordinates-and-gpu-timers">Interpolated normals, texture coordinates, and GPU timers</h2>
<p><em>2023-11-09</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/82208c19754a5fb6528e587c175af30f523c5649">82208c1</a></em></p>
<p><strong>GPU timers</strong></p>
<p>Timing the render pass on the device timeline allows us to keep track of how long rendering the scene actually takes on the GPU, no matter what I do on the CPU side. The timings are displayed in the UI as a moving average.</p>
<p><img src="/img/pathtracer_devlog/query-timestamps.png" alt="query-timestamps"></p>
<p>My 3080 RTX currently runs the <em>Sponza atrium</em> scene (see below) at roughly 120 FPS at fullscreen resolutions.</p>
<p><strong>Enabling allow-unsafe-apis</strong></p>
<p>WebGPU timestamp queries are disabled by default due to timings being potentially usable for client fingerprinting. Using the timestamp queries requires toggling &ldquo;allow-unsafe-apis&rdquo; (normally toggled via Chrome&rsquo;s settings) using the WebGPU native&rsquo;s struct extension mechanism:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00f">const</span> <span style="color:#2b91af">char</span>*               allowUnsafeApisToggle = <span style="color:#a31515">&#34;allow_unsafe_apis&#34;</span>;
</span></span><span style="display:flex;"><span>WGPUDawnTogglesDescriptor instanceToggles = {
</span></span><span style="display:flex;"><span>    .chain =
</span></span><span style="display:flex;"><span>        WGPUChainedStruct{
</span></span><span style="display:flex;"><span>            .next = <span style="color:#00f">nullptr</span>,
</span></span><span style="display:flex;"><span>            .sType = WGPUSType_DawnTogglesDescriptor,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    .enabledTogglesCount = 1,
</span></span><span style="display:flex;"><span>    .enabledToggles = &amp;allowUnsafeApisToggle,
</span></span><span style="display:flex;"><span>    .disabledTogglesCount = 0,
</span></span><span style="display:flex;"><span>    .disabledToggles = <span style="color:#00f">nullptr</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#00f">const</span> WGPUInstanceDescriptor instanceDesc{
</span></span><span style="display:flex;"><span>    .nextInChain = &amp;instanceToggles.chain,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#00f">const</span> WGPUInstance instance = wgpuCreateInstance(&amp;instanceDesc);
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Loading normals and texture coordinates, triangle interpolation</strong></p>
<p>The model surface normals and texture coordinates are loaded from the model. The model now exposes arrays of vertex attributes:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00f">class</span> <span style="color:#2b91af">GltfModel</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span>:
</span></span><span style="display:flex;"><span>    GltfModel(std::filesystem::path gltfPath);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Positions&gt;   positions() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mPositions; }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Normals&gt;     normals() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mNormals; }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> TexCoords&gt;   texCoords() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mTexCoords; }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> std::size_t&gt; baseColorTextureIndices() <span style="color:#00f">const</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> mBaseColorTextureIndices;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Texture&gt; baseColorTextures() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mBaseColorTextures; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">private</span>:
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>Normals and texture coordinates are interpolated at the intersection point using the intersection&rsquo;s barycentric coordinates:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">if</span> rayIntersectBvh(ray, T_MAX, &amp;intersection, &amp;triangleIdx) {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> b = intersection.b;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> tnorms = normals[triangleIdx];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> n = b[0] * tnorms[0] + b[1] * tnorms[1] + b[2] * tnorms[2];
</span></span><span style="display:flex;"><span>    color = 0.5f * (vec3f(1f, 1f, 1f) + n);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here&rsquo;s the famous <em>Sponza atrium</em> scene demonstrating the smoothly interpolated normals:</p>
<p><img src="/img/pathtracer_devlog/sponza-normal-interpolation.png" alt="sponza-interpolated-normals"></p>
<h2 id="loading-textures">Loading textures</h2>
<p><em>2023-11-08</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/170626529372f4c12c6f0d1231a4eacf83588a39">1706265</a></em></p>
<p>The glTF model loader now loads textures, and the base color textures are exposed in the model:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00f">class</span> <span style="color:#2b91af">GltfModel</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span>:
</span></span><span style="display:flex;"><span>    GltfModel(std::filesystem::path gltfPath);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Triangle&gt;    triangles() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mTriangles; }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> std::size_t&gt; baseColorTextureIndices() <span style="color:#00f">const</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> mBaseColorTextureIndices;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    std::span&lt;<span style="color:#00f">const</span> Texture&gt; baseColorTextures() <span style="color:#00f">const</span> { <span style="color:#00f">return</span> mBaseColorTextures; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">private</span>:
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>Each triangle has a base color texture index, and it can be used to index into the array of base color textures. Textures are just arrays of floating point values.</p>
<p>A new <code>textractor</code> executable (short for texture extractor ) is added. It loads a GLTF model, and then dumps each loaded texture into a <code>.ppm</code> file. This way, it can be visually inspected that the textures have been loaded correctly. For instance, here is the duck model&rsquo;s <code>base_color_texture_0</code>:</p>
<p><img src="/img/pathtracer_devlog/base_color_texture_0.jpg" alt="base_color_texture_0"></p>
<h2 id="camera-and-ui-interaction">Camera and UI interaction</h2>
<p><em>2023-11-07</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/1593e8a49309cb1a6aa375410253df53d8e7dd5e">1593e8a</a></em></p>
<p>In order to work with arbitrary 3d models, camera positions and parameters should not be hard-coded. To kickstart scene interaction, two things are implemented:</p>
<ul>
<li>A &ldquo;fly camera&rdquo;, which allows you to move around and pan the scene around using the mouse.</li>
<li>A UI integration, and a panel which allows you to edit the camera&rsquo;s speed, and vfov.</li>
</ul>
<p>The UI panel also prints out scene debug information:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Scene
</span></span><span style="display:flex;"><span>camera position: (8.00, 2.80, -8.30)
</span></span><span style="display:flex;"><span>root centroid: (0.13, 0.87, -0.04)
</span></span></code></pre></td></tr></table>
</div>
</div><p>A bug with the model loader&rsquo;s model transform meant that the duck was hundreds of units away from the camera vertically. Without the debug UI, it was hard to tell whether I just couldn&rsquo;t find the model in space, or whether the camera controller had a problem.</p>
<p><img src="/img/pathtracer_devlog/imgui-camera-interaction.png" alt="camera-imgui-interaction"></p>
<h2 id="raytracing-triangles-on-the-gpu-">Raytracing triangles on the GPU </h2>
<p><em>2023-11-06</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/e950ea8d99b467346a88bc32ca2f69f16e17f3c3">e950ea8</a></em></p>
<p>Today&rsquo;s achievement:</p>
<p><img src="/img/pathtracer_devlog/raytraced-duck-normals.png" alt="raytraced-duck"></p>
<p>The BVH and all intersection testing functions are ported to the shader. The rays from the previous devlog entry are now directly used against the BVH.</p>
<p>Porting the BVH to the GPU involved adjusting the memory layout of a number of structs. <code>Triangle</code>s, <code>Aabb</code>s, and the <code>BvhNode</code>s all have vectors in them which need to be 16-byte aligned in memory. This was achieved by padding the structs out. E.g. <code>BvhNode</code>,</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>-struct BvhNode
</span></span><span style="display:flex;"><span>-{
</span></span><span style="display:flex;"><span>-    Aabb aabb;                   // offset: 0, size: 24
</span></span><span style="display:flex;"><span>-    union
</span></span><span style="display:flex;"><span>-    {
</span></span><span style="display:flex;"><span>-        std::uint32_t trianglesOffset;
</span></span><span style="display:flex;"><span>-        std::uint32_t secondChildOffset;
</span></span><span style="display:flex;"><span>-    };                           // offset: 24, size: 4
</span></span><span style="display:flex;"><span>-    std::uint16_t triangleCount; // offset: 28, size: 2
</span></span><span style="display:flex;"><span>-    std::uint16_t splitAxis;     // offset: 30, size: 2
</span></span><span style="display:flex;"><span>-};
</span></span><span style="display:flex;"><span>+struct BvhNode
</span></span><span style="display:flex;"><span>+{
</span></span><span style="display:flex;"><span>+    Aabb32        aabb;              // offset: 0, size: 32
</span></span><span style="display:flex;"><span>+    std::uint32_t trianglesOffset;   // offset: 32, size: 4
</span></span><span style="display:flex;"><span>+    std::uint32_t secondChildOffset; // offset: 36, size: 4,
</span></span><span style="display:flex;"><span>+    std::uint32_t triangleCount;     // offset: 40, size: 4
</span></span><span style="display:flex;"><span>+    std::uint32_t splitAxis;         // offset: 44, size: 4
</span></span><span style="display:flex;"><span>+};
</span></span></code></pre></td></tr></table>
</div>
</div><p>I also tried using AI (GitHub Copilot) to translate some of the hundreds of lines of intersection testing code to WGSL. It worked well in the sense that only certain patterns of expression had to be fixed. I likely avoided errors that I would have introduced manually porting the code over.</p>
<p> TIL about the <code>@must_use</code> tag in WGSL. It&rsquo;s used as an annotation for functions which return values and don&rsquo;t have side effects. Not using the function in assignment or an expression becomes a compile error.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>@must_use
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> rayPointAtParameter(ray: <span style="color:#2b91af">Ray</span>, t: <span style="color:#2b91af">f32</span>) -&gt; <span style="color:#2b91af">vec3f</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> ray.origin + t * ray.direction;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="raytracing-spheres-on-the-gpu">Raytracing spheres on the GPU</h2>
<p><em>2023-11-04</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/16f6255df4ebb34589d2541ddb9a67dbdfcf846a">16f6255</a></em></p>
<p>Before attempting to raytrace triangles on the GPU, first I need to demonstrate that the camera actually works in the shader.</p>
<p>To do so, a simple raytracing scenario is first implemented. An array of spheres, stored directly in the shader is added. Ray-sphere intersection code is copied over from my <a href="https://github.com/Nelarius/weekend-raytracer-wgpu">weekend-raytracer-wgpu</a> project. The spheres are colored according to their surface normal vector. The spheres are visible and now I know that the camera works!</p>
<p><img src="/img/pathtracer_devlog/raytraced-spheres.png" alt="raytraced-spheres"></p>
<p>The camera and the frame data struct are bundled together into on uniform buffer.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">struct</span> <span style="color:#2b91af">RenderParams</span> {
</span></span><span style="display:flex;"><span>  frameData: <span style="color:#2b91af">FrameData</span>,
</span></span><span style="display:flex;"><span>  camera: <span style="color:#2b91af">Camera</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">struct</span> <span style="color:#2b91af">FrameData</span> {
</span></span><span style="display:flex;"><span>  dimensions: <span style="color:#2b91af">vec2u</span>,
</span></span><span style="display:flex;"><span>  frameCount: <span style="color:#2b91af">u32</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">struct</span> <span style="color:#2b91af">Camera</span> {
</span></span><span style="display:flex;"><span>  eye: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>  lowerLeftCorner: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>  horizontal: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>  vertical: <span style="color:#2b91af">vec3f</span>,
</span></span><span style="display:flex;"><span>  lensRadius: <span style="color:#2b91af">f32</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>I used <a href="https://webgpufundamentals.org/webgpu/lessons/resources/wgsl-offset-computer.html#x=5d00000100bf06000000000000003d88886237289d13c4320e1a9ba574a7281bf711b8e0fe2ad3ce912bab0e0e45d434d61bb7773cbc401503b1a5422bc9bea039d06b8d7965bfdc6e368ea7d5dafe3438cbb62b089a4d9cec6dc7979747e1b214b3e964bcbcbf7488c72aa713fe7c5d73817e3b3f445d649816a64ac8072c28ba8c3dce046ddbe50ca41aeaa4c22ead3b60c0acb96d367309eaec44952e3088be8405bf4fae4fc8cca8764a61cee989b43b51c4fcd21564ea233ad813d4a383f2d702e9cc9f4da3f8a794715769609bd818144076ed26f05db15962b5ef3ed314fd1b0f9538ccaad3e137698dc9d42ff06c08084bc32a2d7e8edc871d8dee675148c5a69cbb85d7d8d2c61bfa357e3f573512742e291a19227c79587c6bc9e71e9b15305f2fe76e51479fea54e4d78276c06f0294f47a21d12a3b09f6e1d1ef457fdd7aed7c590bfa02acd462ad6ff2d7e62dbb7609d8b4139cb0812f4a4a96b489b24a1963fe930c202c18a8229db2e5accddd0b19c255588f10410f76e862e928cedfaa31322b931e77c0ba9b0b20c07bb7d05903330cd8008ce0ce0318e88decdbb3906947888459f57609602735cfa2db9c606f77bcc82c6500001280a20b784b165a2e3e1d3273bbbf21bd2e6b828ac3e04932d4f50adc1059d34176dbce9a8f0725b8fa47e3968be59bbd8b85e3a3db336c824942704a1cc7aa5a982120d7d7e9113d2706ab1b6051452e4f4c087985d5bd5c5c749bc6cc8e0faafba53e2a04a3db328d4d21224c6447f924a9aae62dff94d9287ecc977a49eb75d4e4ac92e4c77b755f13210bb0a3899a30f4cf264b2f8cebfdbaf9a827c79b4babb8c669dd0045488f010ab17f6c12b6d529b0b35ef34a0d8fb7c5831891fe979eea">WGSL Offset Computer</a>, a great online resource for enumerating and drawing the memory layout of your WGSL structs, as a sanity check that my memory layout for <code>renderParams</code> was correct.</p>
<p><img src="/img/pathtracer_devlog/renderparams-layout.jpg" alt="renderparams-memory-layout"></p>
<h2 id="hello-bounding-volume-hierarchies">Hello, bounding volume hierarchies</h2>
<p><em>2023-11-02</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/624e5ead16424fb75c2fd37cac0c9edd0f113690">624e5ea</a></em></p>
<p>This entry marks the first step towards being able to shoot rays at complex triangle geometry. A bounding volume hierarchy (BVH) is introduced (<code>common/bvh.hpp</code>) and tested.</p>
<p>The test (<code>tests/bvh.cpp</code>) intersects rays with the BVH, and uses a brute-force test against the full array of triangles as the ground truth. The intersection test result (did intersect or did not) and the intersection point, in the case of intersection, must agree for all camera rays in order for the test to pass.</p>
<p>As an additional end-to-end sanity check, a new executable target (<code>bvh-visualizer</code>) is introduced. Primary camera rays are generated and the number of BVH nodes visited per ray is visualized as an image.</p>
<p><img src="/img/pathtracer_devlog/duck-bvh.jpg" alt="duck bvh"></p>
<h2 id="gpubuffer"><code>GpuBuffer</code></h2>
<p><em>2023-11-01</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/0a826c4d6e3649c2de906b60d153469f97e20e7e">0a826c4</a></em></p>
<p>Not a lot of visible progress, but <code>GpuBuffer</code> was introduced (in <code>gpu_buffer.hpp</code>) to significantly reduce the amount of boilerplate due to buffers &amp; bind group descriptors:</p>
<p>Showing 5 changed files with <strong>254 additions</strong> and <strong>275 deletions</strong>.</p>
<p>On another note, used <em>immediately invoked lambda functions</em> in a constructor initializer for the first time today:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Renderer::Renderer(<span style="color:#00f">const</span> RendererDescriptor&amp; rendererDesc, <span style="color:#00f">const</span> GpuContext&amp; gpuContext)
</span></span><span style="display:flex;"><span>    : frameDataBuffer(...),
</span></span><span style="display:flex;"><span>      pixelBuffer(
</span></span><span style="display:flex;"><span>          gpuContext.device,
</span></span><span style="display:flex;"><span>          <span style="color:#a31515">&#34;pixel buffer&#34;</span>,
</span></span><span style="display:flex;"><span>          WGPUBufferUsage_CopyDst | WGPUBufferUsage_Storage,
</span></span><span style="display:flex;"><span>          [&amp;rendererDesc]() -&gt; std::size_t {
</span></span><span style="display:flex;"><span>              <span style="color:#00f">const</span> Extent2i    largestResolution = rendererDesc.maxFramebufferSize;
</span></span><span style="display:flex;"><span>              <span style="color:#00f">const</span> std::size_t numPixels =
</span></span><span style="display:flex;"><span>                  <span style="color:#00f">static_cast</span>&lt;std::size_t&gt;(largestResolution.x * largestResolution.y);
</span></span><span style="display:flex;"><span>              <span style="color:#00f">return</span> sizeof(glm::vec3) * numPixels;
</span></span><span style="display:flex;"><span>          }()),
</span></span><span style="display:flex;"><span>      ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s busy looking, but it enables you to do actual work in the constructor initializer. Doing all the work in the constructor initializers like this could make move constructors unnecessary.</p>
<h2 id="gpu-generated-noise">GPU-generated noise</h2>
<p><em>2023-10-31</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/645c09c377face80354e820875c0be9181a18124">645c09c</a></em></p>
<p>The major highlights of the day include generating noise on the GPU and displaying it, as well as cleaning up the main function using a new <code>Window</code> abstraction.</p>
<p><strong><code>Window</code></strong></p>
<p>A simple <code>Window</code> abstraction is introduced to automate GLFW library and window init and cleanup. <code>main</code> does not yet have an exception handler, but this abstraction is a step closer to ensuring all resources are cleaned up even when exceptions occur.</p>
<p><strong>GPU noise</strong></p>
<p>Noise is generated on the GPU using the following functions.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00f">fn</span> rngNextFloat(state: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) -&gt; <span style="color:#2b91af">f32</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> x = rngNextInt(state);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> <span style="color:#2b91af">f32</span>(x) / <span style="color:#2b91af">f32</span>(0xffffffffu);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">fn</span> rngNextInt(state: <span style="color:#2b91af">ptr</span>&lt;function, <span style="color:#2b91af">u32</span>&gt;) {
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// PCG random number generator
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">// Based on https://www.shadertoy.com/view/XlGcRh
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#00f">let</span> newState = *state * 747796405u + 2891336453u;
</span></span><span style="display:flex;"><span>    *state = newState;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">let</span> word = ((newState &gt;&gt; ((newState &gt;&gt; 28u) + 4u)) ^ newState) * 277803737u;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> (word &gt;&gt; 22u) ^ word;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>NOTE: A reader pointed out that the implementation contained in the linked commit is incorrect. The functions listed above are the correct implementation of a PCG random number generator.</p>
<p>Each frame,</p>
<ol>
<li><code>rngNextFloat</code> is used in a compute shader to generate RGB values</li>
<li>RGB values are stored in a pixel buffer</li>
<li>The pixel buffer is mapped to the full screen quad from the previous day.</li>
</ol>
<p>This approach is a bit more complex than necessary, and could just be done in the fragment shader.</p>
<p><img src="/img/pathtracer_devlog/gpu-noise.png" alt="gpu noise"></p>
<h2 id="fullscreen-quad">Fullscreen quad</h2>
<p><em>2023-10-30</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/51387d7b447800b0ffc25e3f2c1526e6fc2bf0f5">51387d7</a></em></p>
<p>After 1000 lines of WebGPU plumbing code, the first <em>pair</em> of triangles is displayed on the screen in the shape of a fullscreen quad, and the UV coordinates are displayed as a color.</p>
<p>The <code>pt</code> executable contains</p>
<ul>
<li>A <code>GpuContext</code> for initializing the WebGPU instance, surface, adapter, device, queue, and the swap chain.</li>
<li>A distinct <code>Renderer</code> which initializes a render pipeline, a uniform and vertex buffer, using the <code>GpuContext</code>.</li>
</ul>
<p>The renderer draws to the screen using a fullscreen quad. For now, the texture coordinates are displayed as colors.</p>
<p><img src="/img/pathtracer_devlog/fullscreen-quad.png" alt="fullscreen quad"></p>
<h2 id="hello-glfw">Hello, GLFW!</h2>
<p><em>2023-10-29</em></p>
<p><em>Commit: <a href="https://github.com/Nelarius/rayfinder/commit/4df39fa7a165f10e7582847c999bf02e60a6ec6a">4df39fa</a></em></p>
<p>All projects have to start somewhere.</p>
<ul>
<li>Defined a <code>pt</code> executable target in CMake. The goal is for this executable to open up a scene and display it by doing pathtracing on the GPU.</li>
<li>The GLFW library dependency added using CMake&rsquo;s <code>FetchContent</code>.</li>
<li>An empty window is opened with a window title. No GPU rendering support yet, only calls to <code>glfwSwapBuffers</code>.</li>
</ul>
<p>A windows opens with a black frame.</p>
<p><img src="/img/pathtracer_devlog/hello-glfw.png" alt="hello, glfw"></p>

        </div>

        
        
        <div class="article-toc" >
            <h3>Contents</h3>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#first-step-towards-temporal-filtering-simple-accumulation">First step towards temporal filtering: simple accumulation</a></li>
    <li><a href="#raytracing-in-a-compute-pipeline">Raytracing in a compute pipeline</a></li>
    <li><a href="#animated-blue-noise">Animated blue noise</a></li>
    <li><a href="#deferred-bounced-lighting">Deferred bounced lighting</a></li>
    <li><a href="#support-for-larger-scenes">Support for larger scenes</a></li>
    <li><a href="#deferred-direct-lighting">Deferred direct lighting</a></li>
    <li><a href="#rendering-the-sky-and-albedo-in-a-deferred-render-pass">Rendering the sky and albedo in a deferred render pass</a></li>
    <li><a href="#first-steps-towards-a-deferred-renderer-">First steps towards a deferred renderer </a></li>
    <li><a href="#gallery-of-failures">Gallery of failures</a></li>
    <li><a href="#copying-shader-source-files-into-a-string-at-build-time">Copying shader source files into a string at build time</a></li>
    <li><a href="#depth-of-field-using-the-thin-lens-approximation">Depth of field using the thin lens approximation</a></li>
    <li><a href="#adding-atmospheric-turbidity-controls">Adding atmospheric turbidity controls</a></li>
    <li><a href="#adding-physically-motivated-sunlight-to-the-scene-">Adding physically-motivated sunlight to the scene </a></li>
    <li><a href="#quick-color-encoding-fix">Quick color encoding fix</a></li>
    <li><a href="#adding-sunlight-to-the-scene">Adding sunlight to the scene</a></li>
    <li><a href="#implementing-tiled-texture-support">Implementing tiled texture support</a></li>
    <li><a href="#avoiding-triangle-self-intersection">Avoiding triangle self-intersection</a></li>
    <li><a href="#filmic-tone-mapping-and-better-tone-mapping-controls">Filmic tone mapping and better tone mapping controls</a></li>
    <li><a href="#integrating-a-physically-based-sky-model">Integrating a physically-based sky model</a></li>
    <li><a href="#even-better-estimator-simple-temporal-accumulation">Even better estimator: simple temporal accumulation</a></li>
    <li><a href="#better-estimator-importance-sampling-surface-normal-directions">Better estimator: importance sampling surface normal directions</a>
      <ul>
        <li><a href="#inverse-transform-sampling-the-cosine-weighted-unit-hemisphere">Inverse transform sampling the cosine-weighted unit hemisphere.</a></li>
      </ul>
    </li>
    <li><a href="#the-first-physically-based-pathtracer">The first physically-based pathtracer</a>
      <ul>
        <li><a href="#inverse-transform-sampling-the-unit-hemisphere">Inverse transform sampling the unit hemisphere.</a></li>
      </ul>
    </li>
    <li><a href="#simple-texture-support-">Simple texture support </a></li>
    <li><a href="#interpolated-normals-texture-coordinates-and-gpu-timers">Interpolated normals, texture coordinates, and GPU timers</a></li>
    <li><a href="#loading-textures">Loading textures</a></li>
    <li><a href="#camera-and-ui-interaction">Camera and UI interaction</a></li>
    <li><a href="#raytracing-triangles-on-the-gpu-">Raytracing triangles on the GPU </a></li>
    <li><a href="#raytracing-spheres-on-the-gpu">Raytracing spheres on the GPU</a></li>
    <li><a href="#hello-bounding-volume-hierarchies">Hello, bounding volume hierarchies</a></li>
    <li><a href="#gpubuffer"><code>GpuBuffer</code></a></li>
    <li><a href="#gpu-generated-noise">GPU-generated noise</a></li>
    <li><a href="#fullscreen-quad">Fullscreen quad</a></li>
    <li><a href="#hello-glfw">Hello, GLFW!</a></li>
  </ul>
</nav>
        </div>
        
        

        


        
        <footer class="article-footer">
            <ul class="article-tag-list">
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://nelari.us/tags/cpp">cpp
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://nelari.us/tags/raytracing">raytracing
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://nelari.us/tags/webgpu">webgpu
                    </a>
                </li>
                
            </ul>
        </footer>
        
    </div>
    
<nav id="article-nav">
    
    <a href="/post/cpp_initialization_notes/" id="article-nav-newer" class="article-nav-link-wrap">
        <div class="article-nav-title"><span>&lt;</span>&nbsp;
            Notes on C&#43;&#43; initialization
        </div>
    </a>
    
    
    <a href="/post/weekend_raytracing_with_wgpu_2/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">Weekend raytracing with wgpu, part 2&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>


</article>

        
    </section>
    <footer id="footer">
    <div class="outer">
            <section class="footer-social">
      
      <a href="//twitter.com/nelarius" target="_blank" title="Twitter"><i class="fab fa-2x fa-fw fa-twitter"></i></a>&nbsp;
      
      
      <a href="//www.linkedin.com/in/nelarius" target="_blank" title="linkedIn"><i class="fab fa-2x fa-fw fa-linkedin"></i></a>&nbsp;
      
      
      
      
      
      <a href="//github.com/Nelarius" target="_blank" title="GitHub"><i class="fab fa-2x fa-fw fa-github"></i></a>&nbsp;
      
      
      
</section>

            <br/>
        <div id="footer-info" class="inner">
            &copy; 2026 Johann Muszynski
        </div>
    </div>
    

    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
        <script>renderMathInElement(document.body);</script>
    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>
